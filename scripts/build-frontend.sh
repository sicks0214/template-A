#!/bin/bash
################################################################################
# å‰ç«¯åˆ†ç¦»å¼æ„å»ºè„šæœ¬
#
# åŠŸèƒ½ï¼š
# 1. åœ¨Dockerå®¹å™¨ä¸­æ„å»ºå‰ç«¯
# 2. å¤åˆ¶æ„å»ºäº§ç‰©åˆ°åç«¯
# 3. éªŒè¯æ„å»ºç»“æœ
#
# ä½¿ç”¨æ–¹æ³•ï¼š
#   ./scripts/build-frontend.sh
################################################################################

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo_success() { echo -e "${GREEN}âœ… $1${NC}"; }
echo_error() { echo -e "${RED}âŒ $1${NC}"; }
echo_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
echo_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }

echo -e "${BLUE}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                               â•‘
â•‘                   å‰ç«¯åˆ†ç¦»å¼æ„å»º                              â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}\n"

# æ£€æŸ¥å‰ç«¯ç›®å½•
if [ ! -d "frontend" ]; then
    echo_error "å‰ç«¯ç›®å½•ä¸å­˜åœ¨"
    exit 1
fi

# ============================================================================
# Step 1: æ£€æŸ¥package-lock.json
# ============================================================================
echo_info "[æ­¥éª¤ 1] æ£€æŸ¥package-lock.json"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

cd frontend

if [ ! -f "package-lock.json" ]; then
    echo_warning "package-lock.jsonä¸å­˜åœ¨ï¼Œç”Ÿæˆä¸­..."
    docker run --rm -v $(pwd):/app -w /app node:22-alpine sh -c "npm install --package-lock-only"
    echo_success "package-lock.jsonç”Ÿæˆå®Œæˆ"
else
    echo_success "package-lock.jsonå·²å­˜åœ¨"
fi

echo ""

# ============================================================================
# Step 2: Dockerå®¹å™¨ä¸­æ„å»º
# ============================================================================
echo_info "[æ­¥éª¤ 2] Dockerå®¹å™¨ä¸­æ„å»ºå‰ç«¯"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo_info "ä½¿ç”¨ Node.js 22 Alpine é•œåƒ"
echo_info "æ‰§è¡Œ: npm ci && npm run build"
echo ""

docker run --rm \
  -v $(pwd):/app \
  -w /app \
  node:22-alpine sh -c "
    echo 'âœ å®‰è£…ä¾èµ–...' && \
    npm ci --no-audit --no-fund && \
    echo && \
    echo 'âœ æ„å»ºå‰ç«¯...' && \
    npm run build && \
    echo && \
    echo 'âœ ä¿®æ”¹æ–‡ä»¶æƒé™...' && \
    chown -R 1000:1000 dist 2>/dev/null || true
  "

if [ $? -ne 0 ]; then
    echo_error "å‰ç«¯æ„å»ºå¤±è´¥"
    cd ..
    exit 1
fi

echo ""
echo_success "å‰ç«¯æ„å»ºå®Œæˆ"

# ============================================================================
# Step 3: éªŒè¯æ„å»ºç»“æœ
# ============================================================================
echo ""
echo_info "[æ­¥éª¤ 3] éªŒè¯æ„å»ºç»“æœ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

if [ ! -d "dist" ]; then
    echo_error "æ„å»ºç›®å½•ä¸å­˜åœ¨: dist/"
    cd ..
    exit 1
fi

if [ ! -f "dist/index.html" ]; then
    echo_error "index.htmlä¸å­˜åœ¨"
    cd ..
    exit 1
fi

# ç»Ÿè®¡æ–‡ä»¶
FILE_COUNT=$(find dist -type f | wc -l)
DIR_SIZE=$(du -sh dist | cut -f1)

echo_success "æ„å»ºç›®å½•å­˜åœ¨"
echo_info "æ–‡ä»¶æ•°é‡: $FILE_COUNT"
echo_info "ç›®å½•å¤§å°: $DIR_SIZE"

# åˆ—å‡ºä¸»è¦æ–‡ä»¶
echo ""
echo_info "ä¸»è¦æ–‡ä»¶ï¼š"
ls -lh dist/ | head -10

echo ""

# ============================================================================
# Step 4: å¤åˆ¶åˆ°åç«¯
# ============================================================================
echo_info "[æ­¥éª¤ 4] å¤åˆ¶æ„å»ºäº§ç‰©åˆ°åç«¯"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æ¸…ç†æ—§æ–‡ä»¶
if [ -d "../backend/frontend/dist" ]; then
    echo_info "æ¸…ç†æ—§æ–‡ä»¶..."
    rm -rf ../backend/frontend/dist
fi

# åˆ›å»ºç›®å½•
mkdir -p ../backend/frontend

# å¤åˆ¶æ–‡ä»¶
echo_info "å¤åˆ¶æ–‡ä»¶..."
cp -r dist ../backend/frontend/

echo_success "æ–‡ä»¶å¤åˆ¶å®Œæˆ"

cd ..

# ============================================================================
# Step 5: éªŒè¯åç«¯æ–‡ä»¶
# ============================================================================
echo ""
echo_info "[æ­¥éª¤ 5] éªŒè¯åç«¯æ–‡ä»¶"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

if [ -f "backend/frontend/dist/index.html" ]; then
    echo_success "åç«¯å‰ç«¯æ–‡ä»¶å·²å°±ç»ª"
    
    BACKEND_FILE_COUNT=$(find backend/frontend/dist -type f | wc -l)
    BACKEND_DIR_SIZE=$(du -sh backend/frontend/dist | cut -f1)
    
    echo_info "æ–‡ä»¶æ•°é‡: $BACKEND_FILE_COUNT"
    echo_info "ç›®å½•å¤§å°: $BACKEND_DIR_SIZE"
else
    echo_error "åç«¯å‰ç«¯æ–‡ä»¶ä¸å®Œæ•´"
    exit 1
fi

# ============================================================================
# å®Œæˆ
# ============================================================================
echo ""
echo -e "${GREEN}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                               â•‘
â•‘                 âœ… å‰ç«¯æ„å»ºå®Œæˆï¼                             â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}\n"

echo_info "æ„å»ºäº§ç‰©ä½ç½®ï¼š"
echo "  â€¢ å‰ç«¯: frontend/dist/"
echo "  â€¢ åç«¯: backend/frontend/dist/"
echo ""

echo_info "åç»­æ­¥éª¤ï¼š"
echo "  1. æ„å»ºDockeré•œåƒ: docker build -f docker/Dockerfile.simple -t <image> ./backend"
echo "  2. æˆ–ä½¿ç”¨ä¸€é”®éƒ¨ç½²: ./scripts/one-click-deploy.sh"
echo ""

echo -e "${GREEN}ğŸ‰ æ„å»ºæµç¨‹å®Œæˆï¼${NC}\n"
