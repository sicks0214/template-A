# ğŸ—ï¸ é€šç”¨Webåº”ç”¨æ¨¡æ¿ - ç¨‹åºæ¶æ„æ€»ç»“

**ç‰ˆæœ¬**: 2.0.0 (é€šç”¨æ¨¡æ¿ç‰ˆ)  
**ç”Ÿæˆæ—¶é—´**: 2024å¹´10æœˆ1æ—¥  
**æ¶æ„ç±»å‹**: å‰åç«¯åˆ†ç¦» + æ¨¡å—åŒ– + PostgreSQLæ€»ç³»ç»Ÿ

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
3. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
4. [æ ¸å¿ƒç³»ç»Ÿ](#æ ¸å¿ƒç³»ç»Ÿ)
5. [æ•°æ®åº“æ¶æ„](#æ•°æ®åº“æ¶æ„)
6. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
7. [è¿è¡Œæµç¨‹](#è¿è¡Œæµç¨‹)
8. [æ‰©å±•æœºåˆ¶](#æ‰©å±•æœºåˆ¶)

---

## ğŸ“– é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®å®šä½
ä¸€ä¸ª**ç”Ÿäº§çº§é€šç”¨Webåº”ç”¨æ¨¡æ¿**ï¼Œä»ColorMagicé¢œè‰²åˆ†æå·¥å…·æ¼”å˜è€Œæ¥ï¼Œç»è¿‡å®Œæ•´æ¸…ç†å’Œé‡æ„ï¼Œæä¾›ï¼š
- âœ… å¼€ç®±å³ç”¨çš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆè®¤è¯ã€å›½é™…åŒ–ã€åé¦ˆï¼‰
- âœ… æ¨¡å—åŒ–æ¶æ„ï¼ˆå¯æ’æ‹”ä¸šåŠ¡æ¨¡å—ï¼‰
- âœ… ä¸€é”®éƒ¨ç½²æ–¹æ¡ˆï¼ˆVPS + Dockerï¼‰
- âœ… PostgreSQLæ€»ç³»ç»Ÿé›†æˆï¼ˆå¤šç«™ç‚¹å…±äº«ï¼‰
- âœ… å®Œæ•´çš„å¼€å‘å’Œéƒ¨ç½²æ–‡æ¡£

### æ ¸å¿ƒä»·å€¼
- **å¿«é€Ÿå¯åŠ¨**ï¼š5åˆ†é’Ÿå®Œæˆé…ç½®å’Œéƒ¨ç½²
- **æ¨¡å—åŒ–**ï¼šä¸šåŠ¡åŠŸèƒ½ç‹¬ç«‹ï¼Œæ˜“äºæ‰©å±•
- **è§„èŒƒåŒ–**ï¼šç¬¦åˆVPSéƒ¨ç½²æœ€ä½³å®è·µ
- **å¯æ‰©å±•**ï¼šæ”¯æŒ1-20ä¸ªç«™ç‚¹å…±äº«èµ„æº

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### å‰ç«¯æŠ€æœ¯æ ˆ

```typescript
{
  "æ ¸å¿ƒæ¡†æ¶": "React 18",
  "è¯­è¨€": "TypeScript 5.0",
  "è·¯ç”±": "React Router DOM 6",
  "çŠ¶æ€ç®¡ç†": "Zustand 4",
  "UIæ¡†æ¶": "TailwindCSS 3.3",
  "ç»„ä»¶åº“": "Radix UI",
  "è¡¨å•ç®¡ç†": "React Hook Form 7",
  "å›½é™…åŒ–": "react-i18next 13",
  "HTTPå®¢æˆ·ç«¯": "Axios 1.5",
  "æ•°æ®è·å–": "TanStack Query 5",
  "æ„å»ºå·¥å…·": "Vite 4",
  "å›¾æ ‡": "Lucide React"
}
```

**å…³é”®ä¾èµ–**:
- `i18next` + `react-i18next`: 8ç§è¯­è¨€å›½é™…åŒ–
- `zustand`: è½»é‡çº§çŠ¶æ€ç®¡ç†
- `react-router-dom`: SPAè·¯ç”±
- `@radix-ui/*`: æ— éšœç¢UIç»„ä»¶
- `tailwindcss`: å®ç”¨ä¼˜å…ˆCSSæ¡†æ¶

### åç«¯æŠ€æœ¯æ ˆ

```typescript
{
  "è¿è¡Œæ—¶": "Node.js 18+",
  "æ¡†æ¶": "Express 4",
  "è¯­è¨€": "TypeScript 5.0",
  "æ•°æ®åº“": "PostgreSQL 15",
  "ORM": "Prisma 5.0",
  "æ•°æ®åº“é©±åŠ¨": "pg 8.16",
  "è®¤è¯": "JWT (jsonwebtoken 9.0)",
  "å¯†ç åŠ å¯†": "bcrypt 5.1",
  "ç¼“å­˜": "Redis 4.6 (å¯é€‰)",
  "å›¾åƒå¤„ç†": "Sharp 0.34 (å·²ç§»é™¤)",
  "æ—¥å¿—": "Winston 3.10",
  "éªŒè¯": "Joi 17.9 + Zod 3.22",
  "å‹ç¼©": "compression 1.7"
}
```

**å…³é”®ä¾èµ–**:
- `express`: Webæ¡†æ¶
- `pg`: PostgreSQLå®¢æˆ·ç«¯
- `jsonwebtoken`: JWTè®¤è¯
- `bcrypt`: å¯†ç å“ˆå¸Œ
- `redis`: ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
- `compression`: Gzipå‹ç¼©

### å¼€å‘å·¥å…·

```typescript
{
  "åŒ…ç®¡ç†": "npm",
  "TypeScriptç¼–è¯‘": "tsc + tsx",
  "ä»£ç æ£€æŸ¥": "ESLint 8",
  "ä»£ç æ ¼å¼åŒ–": "Prettier 3",
  "æµ‹è¯•æ¡†æ¶": "Jest 29 + Vitest",
  "APIæµ‹è¯•": "Supertest 6",
  "çƒ­é‡è½½": "tsx watch + Vite HMR",
  "å®¹å™¨åŒ–": "Docker + Docker Compose"
}
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·å±‚                              â”‚
â”‚  (æµè§ˆå™¨ / ç§»åŠ¨ç«¯ / APIå®¢æˆ·ç«¯)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CDN / Cloudflare                         â”‚
â”‚  (DNSè§£æ / SSLè¯ä¹¦ / DDoSé˜²æŠ¤ / ç¼“å­˜åŠ é€Ÿ)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Nginx Proxy Manager (NPM)                     â”‚
â”‚  (åå‘ä»£ç† / SSLç»ˆæ­¢ / åŸŸåè·¯ç”± / è®¿é—®æ—¥å¿—)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   webproxy    â”‚         â”‚  shared_net   â”‚
â”‚  (å¤–éƒ¨ç½‘ç»œ)   â”‚         â”‚ (å†…éƒ¨ç½‘ç»œ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚
        â–¼                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åº”ç”¨å®¹å™¨ (siteN)       â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡         â”‚                      â”‚  â”‚
â”‚  â”‚  (React SPA + Index.html)    â”‚                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
â”‚                 â”‚                                       â”‚  â”‚
â”‚                 â–¼                                       â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚            åç«¯APIæœåŠ¡                          â”‚   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  Expressåº”ç”¨                             â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ CORSé…ç½® (å¤šåŸŸåæ”¯æŒ)                â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ é€Ÿç‡é™åˆ¶                             â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ å‹ç¼©ä¸­é—´ä»¶                           â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ è®¤è¯ä¸­é—´ä»¶ (JWT)                     â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ è·¯ç”±å¤„ç†                             â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚
â”‚  â”‚     â”‚                                            â”‚   â”‚  â”‚
â”‚  â”‚     â”œâ”€ /api/auth       (è®¤è¯è·¯ç”±)              â”‚   â”‚  â”‚
â”‚  â”‚     â”œâ”€ /api/feedback   (åé¦ˆè·¯ç”±)              â”‚   â”‚  â”‚
â”‚  â”‚     â”œâ”€ /api/health     (å¥åº·æ£€æŸ¥)              â”‚   â”‚  â”‚
â”‚  â”‚     â””â”€ /api/{module}   (æ¨¡å—è·¯ç”±)              â”‚   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                           â”‚                                  â”‚
                           â–¼                                  â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
                â”‚   ç¼“å­˜å±‚ (å¯é€‰)      â”‚                     â”‚
                â”‚   Redis 4.6          â”‚                     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
                                                              â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   PostgreSQLæ€»ç³»ç»Ÿ               â”‚
                â”‚   (postgres_master)              â”‚
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                â”‚  â”‚  ä¸»æ•°æ®åº“: postgres        â”‚  â”‚
                â”‚  â”‚  â”œâ”€ unified_feedback       â”‚  â”‚
                â”‚  â”‚  â”œâ”€ site1_* è¡¨             â”‚  â”‚
                â”‚  â”‚  â”œâ”€ site2_* è¡¨             â”‚  â”‚
                â”‚  â”‚  â””â”€ siteN_* è¡¨             â”‚  â”‚
                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                â”‚                                  â”‚
                â”‚  ç”¨æˆ·æƒé™éš”ç¦»:                   â”‚
                â”‚  â”œâ”€ site1_user â†’ site1_* è¡¨    â”‚
                â”‚  â”œâ”€ site2_user â†’ site2_* è¡¨    â”‚
                â”‚  â””â”€ siteN_user â†’ siteN_* è¡¨    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ç‰¹ç‚¹

#### 1. å•ä½“å®¹å™¨éƒ¨ç½²
- **å‰ç«¯ + åç«¯** æ‰“åŒ…åœ¨åŒä¸€ä¸ªDockerå®¹å™¨
- å‰ç«¯æ„å»ºäº§ç‰©å¤åˆ¶åˆ° `backend/frontend/dist/`
- åç«¯é€šè¿‡Expressæ‰˜ç®¡å‰ç«¯é™æ€æ–‡ä»¶
- ç®€åŒ–éƒ¨ç½²ï¼Œå‡å°‘ç½‘ç»œè·³è½¬

#### 2. åŒç½‘ç»œæ¶æ„
```yaml
networks:
  webproxy:      # å¤–éƒ¨è®¿é—®ç½‘ç»œ
    external: true
  shared_net:    # å†…éƒ¨æ•°æ®åº“ç½‘ç»œ
    external: true
```

- **webproxy**: è¿æ¥NPMï¼Œå¯¹å¤–æä¾›æœåŠ¡
- **shared_net**: è¿æ¥postgres_masterï¼Œæ•°æ®åº“é€šä¿¡

#### 3. åˆ†ç¦»å¼æ„å»ºç­–ç•¥
```bash
# å‰ç«¯ç‹¬ç«‹æ„å»ºï¼ˆDockerå®¹å™¨ä¸­ï¼‰
cd frontend
docker run --rm -v $(pwd):/app -w /app node:22-alpine sh -c "
  npm ci && npm run build
"

# å¤åˆ¶åˆ°åç«¯
cp -r dist ../backend/frontend/

# åç«¯å•é˜¶æ®µæ„å»º
cd backend
docker build -f Dockerfile.simple -t siteN:latest .
```

**ä¼˜åŠ¿**:
- âœ… é¿å…å¤šé˜¶æ®µæ„å»ºå¤æ‚æ€§
- âœ… æ„å»ºè¿‡ç¨‹æ¸…æ™°å¯æ§
- âœ… ä¾¿äºè°ƒè¯•å’ŒéªŒè¯
- âœ… é¿å…"åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘"é—®é¢˜

---

## ğŸ¯ æ ¸å¿ƒç³»ç»Ÿ

### 1. è®¤è¯ç³»ç»Ÿ (Auth System)

#### æ¶æ„è®¾è®¡
```
ç”¨æˆ· â†’ JWTè®¤è¯ â†’ å—ä¿æŠ¤API
  â”œâ”€ æ³¨å†Œ/ç™»å½•
  â”œâ”€ Tokenç”Ÿæˆ (15åˆ†é’Ÿ)
  â”œâ”€ RefreshToken (7å¤©)
  â”œâ”€ å¯†ç åŠ å¯† (bcrypt)
  â””â”€ ä¼šè¯ç®¡ç†
```

#### æ ¸å¿ƒç»„ä»¶

**åç«¯**:
```typescript
backend/src/
â”œâ”€â”€ services/auth/
â”‚   â””â”€â”€ authService.ts           # è®¤è¯ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ authController.ts        # è®¤è¯æ§åˆ¶å™¨
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ auth.ts                  # è®¤è¯è·¯ç”±
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ auth.ts                  # JWTä¸­é—´ä»¶
â””â”€â”€ types/
    â””â”€â”€ auth.ts                  # ç±»å‹å®šä¹‰
```

**å‰ç«¯**:
```typescript
frontend/src/
â”œâ”€â”€ components/Auth/
â”‚   â”œâ”€â”€ AuthModals.tsx           # ç™»å½•/æ³¨å†Œå¼¹çª—
â”‚   â”œâ”€â”€ LoginForm.tsx            # ç™»å½•è¡¨å•
â”‚   â”œâ”€â”€ RegisterForm.tsx         # æ³¨å†Œè¡¨å•
â”‚   â””â”€â”€ UserProfile.tsx          # ç”¨æˆ·èµ„æ–™
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useAuth.ts               # è®¤è¯Hook
â””â”€â”€ types/
    â””â”€â”€ auth.ts                  # ç±»å‹å®šä¹‰
```

#### æ ¸å¿ƒåŠŸèƒ½

1. **ç”¨æˆ·æ³¨å†Œ**
   - é‚®ç®±/ç”¨æˆ·å/å¯†ç éªŒè¯
   - å¯†ç å¼ºåº¦æ£€æŸ¥
   - è‡ªåŠ¨ç”ŸæˆToken

2. **ç”¨æˆ·ç™»å½•**
   - é‚®ç®±/å¯†ç éªŒè¯
   - å¤±è´¥æ¬¡æ•°é™åˆ¶ï¼ˆ5æ¬¡é”å®š30åˆ†é’Ÿï¼‰
   - è®°ä½æˆ‘åŠŸèƒ½ï¼ˆRefreshTokenï¼‰

3. **JWTè®¤è¯**
   - AccessToken: 15åˆ†é’Ÿæœ‰æ•ˆæœŸ
   - RefreshToken: 7å¤©æœ‰æ•ˆæœŸ
   - è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

4. **ä¼šè¯ç®¡ç†**
   - å¤šè®¾å¤‡ç™»å½•
   - ä¼šè¯è®°å½•ï¼ˆIPã€User-Agentï¼‰
   - ä¼šè¯æ’¤é”€

#### æ•°æ®è¡¨ç»“æ„
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE {prefix}_users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    avatar_url TEXT,
    role VARCHAR(20) DEFAULT 'user',
    subscription_type VARCHAR(20) DEFAULT 'free',
    status VARCHAR(20) DEFAULT 'active',
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMP,
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆ·æ–°ä»¤ç‰Œè¡¨
CREATE TABLE {prefix}_refresh_tokens (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES {prefix}_users(id),
    token VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    revoked BOOLEAN DEFAULT FALSE
);
```

---

### 2. å›½é™…åŒ–ç³»ç»Ÿ (i18n System)

#### æ¶æ„è®¾è®¡
```
8ç§è¯­è¨€æ”¯æŒ
â”œâ”€ åœŸè€³å…¶è¯­ (tr) - é»˜è®¤
â”œâ”€ ä¸­æ–‡ (zh)
â”œâ”€ è‹±è¯­ (en)
â”œâ”€ æ—¥è¯­ (ja)
â”œâ”€ éŸ©è¯­ (ko)
â”œâ”€ æ³•è¯­ (fr)
â”œâ”€ å¾·è¯­ (de)
â””â”€ ä¿„è¯­ (ru)
```

#### æ ¸å¿ƒç»„ä»¶

```typescript
frontend/src/i18n/
â”œâ”€â”€ index.ts                     # i18nåˆå§‹åŒ–
â”œâ”€â”€ locales/                     # è¯­è¨€æ–‡ä»¶
â”‚   â”œâ”€â”€ tr.json                  # åœŸè€³å…¶è¯­
â”‚   â”œâ”€â”€ zh.json                  # ä¸­æ–‡
â”‚   â”œâ”€â”€ en.json                  # è‹±è¯­
â”‚   â”œâ”€â”€ ja.json                  # æ—¥è¯­
â”‚   â”œâ”€â”€ ko.json                  # éŸ©è¯­
â”‚   â”œâ”€â”€ fr.json                  # æ³•è¯­
â”‚   â”œâ”€â”€ de.json                  # å¾·è¯­
â”‚   â””â”€â”€ ru.json                  # ä¿„è¯­
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ I18nManager.ts           # i18nç®¡ç†å™¨
â”‚   â””â”€â”€ LanguageProvider.tsx     # è¯­è¨€æä¾›è€…
â””â”€â”€ components/
    â””â”€â”€ LanguageSwitcher.tsx     # è¯­è¨€åˆ‡æ¢å™¨
```

#### æ ¸å¿ƒåŠŸèƒ½

1. **è¯­è¨€æ£€æµ‹**
   - ä¼˜å…ˆçº§ï¼šlocalStorage > æµè§ˆå™¨è¯­è¨€ > é»˜è®¤è¯­è¨€
   - è‡ªåŠ¨ä¿å­˜ç”¨æˆ·åå¥½

2. **åŠ¨æ€åŠ è½½**
   - æŒ‰éœ€åŠ è½½è¯­è¨€åŒ…
   - å‡å°‘åˆå§‹åŠ è½½æ—¶é—´

3. **å®æ—¶åˆ‡æ¢**
   - æ— éœ€åˆ·æ–°é¡µé¢
   - ç«‹å³ç”Ÿæ•ˆ

4. **ç¿»è¯‘ç®¡ç†**
   - å‘½åç©ºé—´éš”ç¦»
   - é”®å€¼å¯¹ç»„ç»‡
   - æ”¯æŒæ’å€¼å’Œå¤æ•°

#### ä½¿ç”¨ç¤ºä¾‹
```typescript
import { useTranslation } from 'react-i18next'

const MyComponent = () => {
  const { t, i18n } = useTranslation()
  
  return (
    <div>
      <h1>{t('welcome')}</h1>
      <button onClick={() => i18n.changeLanguage('zh')}>
        åˆ‡æ¢åˆ°ä¸­æ–‡
      </button>
    </div>
  )
}
```

---

### 3. åé¦ˆç³»ç»Ÿ (Feedback System)

#### æ¶æ„è®¾è®¡
```
ç»Ÿä¸€åé¦ˆè¡¨ (unified_feedback)
â”œâ”€ site_id: ç«™ç‚¹æ ‡è¯†
â”œâ”€ type: åé¦ˆç±»å‹
â”œâ”€ content: åé¦ˆå†…å®¹
â””â”€ metadata: é™„åŠ ä¿¡æ¯
```

#### æ ¸å¿ƒç»„ä»¶

**åç«¯**:
```typescript
backend/src/
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ feedbackController.ts    # åé¦ˆæ§åˆ¶å™¨
â””â”€â”€ routes/
    â””â”€â”€ feedback.ts              # åé¦ˆè·¯ç”±
```

**å‰ç«¯**:
```typescript
frontend/src/components/
â””â”€â”€ Layout/
    â””â”€â”€ FloatingFeedback.tsx     # æµ®åŠ¨åé¦ˆæŒ‰é’®
```

#### æ•°æ®è¡¨ç»“æ„
```sql
CREATE TABLE unified_feedback (
    id SERIAL PRIMARY KEY,
    site_id VARCHAR(20) NOT NULL,      -- ç«™ç‚¹æ ‡è¯†
    user_id INTEGER,                    -- ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰
    type VARCHAR(50) NOT NULL,          -- bug/feature/suggestion/other
    content TEXT NOT NULL,              -- åé¦ˆå†…å®¹
    contact_info VARCHAR(255),          -- è”ç³»æ–¹å¼
    user_agent TEXT,                    -- æµè§ˆå™¨ä¿¡æ¯
    url TEXT,                           -- å½“å‰é¡µé¢URL
    screenshot_url TEXT,                -- æˆªå›¾URL
    metadata JSONB,                     -- é™„åŠ æ•°æ®
    status VARCHAR(20) DEFAULT 'pending', -- pending/reviewed/resolved
    admin_notes TEXT,                   -- ç®¡ç†å‘˜å¤‡æ³¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_feedback_site ON unified_feedback(site_id);
CREATE INDEX idx_feedback_created ON unified_feedback(created_at DESC);
```

#### æ ¸å¿ƒåŠŸèƒ½

1. **æäº¤åé¦ˆ**
   - æ”¯æŒ4ç§ç±»å‹ï¼šbug/feature/suggestion/other
   - å¯é€‰ç•™ä¸‹è”ç³»æ–¹å¼
   - è‡ªåŠ¨è®°å½•é¡µé¢ä¿¡æ¯

2. **å¤šç«™ç‚¹éš”ç¦»**
   - é€šè¿‡`site_id`åŒºåˆ†ä¸åŒç«™ç‚¹
   - æ¯ä¸ªç«™ç‚¹ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„åé¦ˆ

3. **çŠ¶æ€ç®¡ç†**
   - pending: å¾…å¤„ç†
   - reviewed: å·²å®¡é˜…
   - resolved: å·²è§£å†³
   - archived: å·²å½’æ¡£

---

### 4. ç¼“å­˜ç³»ç»Ÿ (Cache System)

#### æ¶æ„è®¾è®¡
```
Redisç¼“å­˜ (å¯é€‰)
â”œâ”€ ä¼šè¯ç¼“å­˜
â”œâ”€ APIå“åº”ç¼“å­˜
â””â”€ é¢‘ç‡é™åˆ¶
```

#### æ ¸å¿ƒç»„ä»¶
```typescript
backend/src/services/cache/
â”œâ”€â”€ redisClient.ts               # Rediså®¢æˆ·ç«¯
â””â”€â”€ pixelArtCache.ts            # ç¼“å­˜ç®¡ç†å™¨(å¯æ¸…ç†)
```

#### é…ç½®
```typescript
// å¯ç”¨ç¼“å­˜
ENABLE_REDIS_CACHE=true
CACHE_ENABLED=true

// Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
```

---

## ğŸ—„ï¸ æ•°æ®åº“æ¶æ„

### PostgreSQLæ€»ç³»ç»Ÿæ¶æ„

#### æ ¸å¿ƒæ¦‚å¿µ

**å•å®ä¾‹å¤šç«™ç‚¹**:
- 1ä¸ªPostgreSQLå®ä¾‹æœåŠ¡æ‰€æœ‰ç«™ç‚¹ï¼ˆ1-20ä¸ªï¼‰
- æ¯ä¸ªç«™ç‚¹ç‹¬ç«‹ç”¨æˆ·ï¼ˆsite1_user, site2_user...ï¼‰
- æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹è¡¨å‰ç¼€ï¼ˆmyproject_*, yourproject_*ï¼‰

#### æ¶æ„å›¾
```
PostgreSQLæ€»ç³»ç»Ÿ (postgres_master)
â”œâ”€â”€ æ•°æ®åº“: postgres
â”‚   â”œâ”€â”€ ç»Ÿä¸€åé¦ˆè¡¨
â”‚   â”‚   â””â”€â”€ unified_feedback (æ‰€æœ‰ç«™ç‚¹å…±äº«)
â”‚   â”‚
â”‚   â”œâ”€â”€ ç«™ç‚¹1è¡¨
â”‚   â”‚   â”œâ”€â”€ site1prefix_users
â”‚   â”‚   â”œâ”€â”€ site1prefix_data
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ ç«™ç‚¹2è¡¨
â”‚   â”‚   â”œâ”€â”€ site2prefix_users
â”‚   â”‚   â”œâ”€â”€ site2prefix_data
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ ç«™ç‚¹Nè¡¨
â”‚       â”œâ”€â”€ siteNprefix_users
â”‚       â”œâ”€â”€ siteNprefix_data
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ ç”¨æˆ·æƒé™
â”‚   â”œâ”€â”€ site1_user â†’ åªèƒ½è®¿é—® site1prefix_* è¡¨
â”‚   â”œâ”€â”€ site2_user â†’ åªèƒ½è®¿é—® site2prefix_* è¡¨
â”‚   â””â”€â”€ siteN_user â†’ åªèƒ½è®¿é—® siteNprefix_* è¡¨
â”‚
â””â”€â”€ ç½‘ç»œåˆ«å
    â””â”€â”€ postgres_master (Dockerç½‘ç»œåˆ«å)
```

#### è¿æ¥é…ç½®

```typescript
// æ•°æ®åº“é…ç½®
const dbConfig = {
  host: 'postgres_master',       // Dockerç½‘ç»œåˆ«å
  port: 5432,
  database: 'postgres',           // ä½¿ç”¨ä¸»æ•°æ®åº“
  user: 'site3_user',             // ç«™ç‚¹ç”¨æˆ·
  password: 'site3_pass',         // ç«™ç‚¹å¯†ç 
  ssl: false,                     // VPSå†…éƒ¨ä¸ç”¨SSL
  max: 20,                        // è¿æ¥æ± å¤§å°
}
```

#### è¡¨å‘½åè§„èŒƒ

```sql
-- âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨è¡¨å
CREATE TABLE users ...
CREATE TABLE data ...

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨é¡¹ç›®è¡¨å‰ç¼€
CREATE TABLE myproject_users ...
CREATE TABLE myproject_data ...
```

#### æƒé™éš”ç¦»

```sql
-- åˆ›å»ºç«™ç‚¹ç”¨æˆ·
CREATE USER site3_user WITH PASSWORD 'site3_pass';

-- åªæˆäºˆè¯¥ç«™ç‚¹è¡¨çš„æƒé™
GRANT ALL PRIVILEGES ON myproject_users TO site3_user;
GRANT ALL PRIVILEGES ON myproject_data TO site3_user;

-- æˆäºˆç»Ÿä¸€åé¦ˆè¡¨çš„è¯»å†™æƒé™
GRANT SELECT, INSERT, UPDATE ON unified_feedback TO site3_user;
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### VPSç¯å¢ƒç»“æ„

```bash
/docker/
â”œâ”€â”€ proxy/                    # Nginx Proxy Manager
â”‚   â””â”€â”€ docker-compose.yml
â”‚
â”œâ”€â”€ db_master/               # PostgreSQLæ€»ç³»ç»Ÿ
â”‚   â””â”€â”€ docker-compose.yml
â”‚
â”œâ”€â”€ site1/                   # ç«™ç‚¹1
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ .env
â”‚
â”œâ”€â”€ site2/                   # ç«™ç‚¹2
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ .env
â”‚
â””â”€â”€ siteN/                   # ç«™ç‚¹N
    â”œâ”€â”€ docker-compose.yml
    â””â”€â”€ .env
```

### Dockerç½‘ç»œé…ç½®

```bash
# åˆ›å»ºç½‘ç»œ
docker network create webproxy      # å¤–éƒ¨è®¿é—®ç½‘ç»œ
docker network create shared_net    # æ•°æ®åº“é€šä¿¡ç½‘ç»œ

# ç½‘ç»œè¿æ¥
webproxy:
  - NPM (Nginx Proxy Manager)
  - site1 å®¹å™¨
  - site2 å®¹å™¨
  - siteN å®¹å™¨

shared_net:
  - postgres_master å®¹å™¨
  - site1 å®¹å™¨
  - site2 å®¹å™¨
  - siteN å®¹å™¨
```

### éƒ¨ç½²æµç¨‹

#### 1. ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
# Linux/macOS
./scripts/one-click-deploy.sh

# Windows
scripts\one-click-deploy.bat
```

#### 2. éƒ¨ç½²æ­¥éª¤

```bash
æ­¥éª¤1: ç¯å¢ƒé¢„æ£€æŸ¥
  â”œâ”€ æ£€æŸ¥Docker
  â”œâ”€ æ£€æŸ¥é…ç½®æ–‡ä»¶
  â””â”€ æ£€æŸ¥ç«™ç‚¹ID

æ­¥éª¤2: éªŒè¯é…ç½®
  â”œâ”€ éªŒè¯å¿…éœ€å˜é‡
  â”œâ”€ éªŒè¯æ•°æ®åº“é…ç½®
  â””â”€ éªŒè¯CORSé…ç½®

æ­¥éª¤3: ç¼–è¯‘TypeScript
  â”œâ”€ æ£€æŸ¥node_modules
  â”œâ”€ è¿è¡Œnpm run build
  â””â”€ éªŒè¯distç›®å½•

æ­¥éª¤4: æ„å»ºå‰ç«¯ (åˆ†ç¦»å¼)
  â”œâ”€ ç”Ÿæˆpackage-lock.json
  â”œâ”€ Dockerå®¹å™¨ä¸­æ‰§è¡Œnpm ci
  â”œâ”€ Dockerå®¹å™¨ä¸­æ‰§è¡Œnpm run build
  â””â”€ å¤åˆ¶diståˆ°backend/frontend/

æ­¥éª¤5: æ„å»ºDockeré•œåƒ
  â”œâ”€ ä½¿ç”¨Dockerfile.simple
  â”œâ”€ å•é˜¶æ®µæ„å»º
  â””â”€ æ ‡ç­¾ï¼šsiteN:latest

æ­¥éª¤6: é…ç½®ç½‘ç»œ
  â”œâ”€ åˆ›å»ºwebproxyç½‘ç»œ
  â”œâ”€ åˆ›å»ºshared_netç½‘ç»œ
  â””â”€ é…ç½®postgres_masteråˆ«å

æ­¥éª¤7: åœæ­¢æ—§å®¹å™¨
  â””â”€ docker stop && docker rm

æ­¥éª¤8: å¯åŠ¨æ–°å®¹å™¨
  â”œâ”€ docker run -d
  â”œâ”€ è¿æ¥webproxyç½‘ç»œ
  â””â”€ è¿æ¥shared_netç½‘ç»œ

æ­¥éª¤9: å¥åº·æ£€æŸ¥
  â”œâ”€ ç­‰å¾…æœåŠ¡å¯åŠ¨
  â”œâ”€ æ£€æŸ¥/healthç«¯ç‚¹
  â”œâ”€ æ£€æŸ¥æ•°æ®åº“è¿æ¥
  â””â”€ éªŒè¯CORSé…ç½®

æ­¥éª¤10: æ˜¾ç¤ºä¿¡æ¯
  â”œâ”€ å®¹å™¨IP
  â”œâ”€ è®¿é—®URL
  â””â”€ åç»­æ­¥éª¤
```

### Dockerfileé…ç½®

```dockerfile
# Dockerfile.simple - å•é˜¶æ®µæ„å»º
FROM node:22-alpine

WORKDIR /app

# å®‰è£…ç”Ÿäº§ä¾èµ–
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶ç¼–è¯‘åçš„ä»£ç 
COPY dist ./dist

# å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆå·²åœ¨å¤–éƒ¨æ„å»ºï¼‰
COPY frontend ./frontend

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s \
    CMD node -e "require('http').get('http://localhost:3000/health')"

# å¯åŠ¨åº”ç”¨
CMD ["node", "dist/index.js"]
```

---

## ğŸ”„ è¿è¡Œæµç¨‹

### è¯·æ±‚å¤„ç†æµç¨‹

```
1. ç”¨æˆ·è®¿é—® https://example.com
   â”‚
   â–¼
2. Cloudflare CDN
   â”œâ”€ DNSè§£æ
   â”œâ”€ SSL/TLSç»ˆæ­¢
   â””â”€ DDoSé˜²æŠ¤
   â”‚
   â–¼
3. Nginx Proxy Manager
   â”œâ”€ åŸŸåè·¯ç”±: example.com â†’ siteN:3000
   â”œâ”€ SSLè¯ä¹¦ç®¡ç†
   â””â”€ è®¿é—®æ—¥å¿—
   â”‚
   â–¼
4. åº”ç”¨å®¹å™¨ (siteN)
   â”‚
   â”œâ”€ é™æ€æ–‡ä»¶è¯·æ±‚ (/, /about, /assets/*)
   â”‚  â”‚
   â”‚  â–¼
   â”‚  Expressé™æ€æ–‡ä»¶æœåŠ¡
   â”‚  â””â”€ è¿”å› frontend/dist/index.html
   â”‚     æˆ– frontend/dist/assets/*
   â”‚
   â””â”€ APIè¯·æ±‚ (/api/*)
      â”‚
      â–¼
      Expressè·¯ç”±å¤„ç†
      â”œâ”€ CORSéªŒè¯
      â”œâ”€ é€Ÿç‡é™åˆ¶
      â”œâ”€ JWTè®¤è¯ (å¦‚éœ€è¦)
      â”œâ”€ ä¸šåŠ¡é€»è¾‘å¤„ç†
      â”œâ”€ æ•°æ®åº“æŸ¥è¯¢ (PostgreSQL)
      â””â”€ è¿”å›JSONå“åº”
```

### æ•°æ®åº“è®¿é—®æµç¨‹

```
åº”ç”¨å®¹å™¨
  â”‚
  â–¼
1. è·å–æ•°æ®åº“è¿æ¥
   â”œâ”€ ä»è¿æ¥æ± è·å–è¿æ¥
   â””â”€ é…ç½®: host=postgres_master
  â”‚
  â–¼
2. shared_netç½‘ç»œ
   â”œâ”€ Docker DNSè§£æ
   â””â”€ postgres_master â†’ PostgreSQLå®¹å™¨
  â”‚
  â–¼
3. PostgreSQLè®¤è¯
   â”œâ”€ ç”¨æˆ·: site3_user
   â”œâ”€ å¯†ç : site3_pass
   â””â”€ æ•°æ®åº“: postgres
  â”‚
  â–¼
4. æƒé™æ£€æŸ¥
   â”œâ”€ æ£€æŸ¥ç”¨æˆ·æƒé™
   â””â”€ åªèƒ½è®¿é—® myproject_* è¡¨
  â”‚
  â–¼
5. æ‰§è¡ŒSQLæŸ¥è¯¢
   â”œâ”€ SELECT * FROM myproject_users
   â””â”€ INSERT INTO unified_feedback
  â”‚
  â–¼
6. è¿”å›ç»“æœ
   â””â”€ é‡Šæ”¾è¿æ¥å›è¿æ¥æ± 
```

### ç”¨æˆ·è®¤è¯æµç¨‹

```
1. ç”¨æˆ·ç™»å½•è¯·æ±‚
   POST /api/auth/login
   Body: { email, password, remember_me }
   â”‚
   â–¼
2. authController.login()
   â”‚
   â–¼
3. authService.login()
   â”œâ”€ éªŒè¯é‚®ç®±æ ¼å¼
   â”œâ”€ æŸ¥è¯¢ç”¨æˆ· (getUserByEmail)
   â”œâ”€ æ£€æŸ¥è´¦æˆ·çŠ¶æ€
   â”œâ”€ éªŒè¯å¯†ç  (bcrypt.compare)
   â”œâ”€ é‡ç½®å¤±è´¥æ¬¡æ•°
   â””â”€ æ›´æ–°ç™»å½•ä¿¡æ¯
   â”‚
   â–¼
4. ç”ŸæˆToken
   â”œâ”€ AccessToken (15åˆ†é’Ÿ)
   â”‚  â””â”€ { userId, email, username, subscription_type }
   â”‚
   â””â”€ RefreshToken (7å¤©ï¼Œå¦‚æœremember_me=true)
      â””â”€ ä¿å­˜åˆ°refresh_tokensè¡¨
   â”‚
   â–¼
5. è¿”å›å“åº”
   {
     user: { id, username, email, ... },
     token: "eyJhbGc...",
     refresh_token: "eyJhbGc..." (å¯é€‰)
   }
   â”‚
   â–¼
6. å‰ç«¯å­˜å‚¨Token
   â”œâ”€ localStorage.setItem('token', token)
   â””â”€ localStorage.setItem('refresh_token', refresh_token)
   â”‚
   â–¼
7. åç»­è¯·æ±‚æºå¸¦Token
   Headers: { Authorization: "Bearer eyJhbGc..." }
```

### å—ä¿æŠ¤APIè®¿é—®æµç¨‹

```
1. è¯·æ±‚å—ä¿æŠ¤API
   GET /api/user/profile
   Headers: { Authorization: "Bearer eyJhbGc..." }
   â”‚
   â–¼
2. JWTä¸­é—´ä»¶éªŒè¯
   â”œâ”€ æå–Token
   â”œâ”€ éªŒè¯ç­¾å
   â”œâ”€ æ£€æŸ¥è¿‡æœŸæ—¶é—´
   â””â”€ è§£ç payload
   â”‚
   â–¼
3. éªŒè¯æˆåŠŸ
   â”œâ”€ req.user = decodedPayload
   â””â”€ next() â†’ ç»§ç»­å¤„ç†
   â”‚
   â–¼
4. ä¸šåŠ¡é€»è¾‘
   â””â”€ ä½¿ç”¨req.user.userIdæŸ¥è¯¢æ•°æ®
   â”‚
   â–¼
5. è¿”å›å“åº”
```

---

## ğŸ”Œ æ‰©å±•æœºåˆ¶

### æ¨¡å—åŒ–æ¶æ„

#### æ¨¡å—ç›®å½•ç»“æ„

```
modules/
â””â”€â”€ {module-name}/
    â”œâ”€â”€ frontend/
    â”‚   â”œâ”€â”€ pages/               # é¡µé¢ç»„ä»¶
    â”‚   â”œâ”€â”€ components/          # æ¨¡å—ç»„ä»¶
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ backend/
    â”‚   â”œâ”€â”€ routes/              # APIè·¯ç”±
    â”‚   â”œâ”€â”€ controllers/         # æ§åˆ¶å™¨
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ database/
    â”‚   â””â”€â”€ {module}-tables.sql  # æ•°æ®åº“è¡¨
    â”œâ”€â”€ i18n/
    â”‚   â””â”€â”€ locales/             # ç¿»è¯‘æ–‡ä»¶
    â””â”€â”€ module.config.ts         # æ¨¡å—é…ç½®
```

#### æ¨¡å—æ³¨å†Œ

```typescript
// template-config/module.registry.ts
export class ModuleRegistry {
  // å¯ç”¨æ¨¡å—
  static availableModules = new Map<string, ModuleConfig>([
    ['example-simple', simpleConfig],
    ['my-module', myModuleConfig],  // æ·»åŠ æ–°æ¨¡å—
  ])
  
  // æ¿€æ´»çš„æ¨¡å—
  static activeModules: string[] = [
    'example-simple',
    'my-module',  // æ¿€æ´»æ–°æ¨¡å—
  ]
}
```

#### åˆ›å»ºæ–°æ¨¡å—

```bash
# ä½¿ç”¨è„šæœ¬åˆ›å»º
./scripts/create-new-module.sh my-feature

# è‡ªåŠ¨ç”Ÿæˆï¼š
modules/my-feature/
â”œâ”€â”€ frontend/pages/MyFeaturePage.tsx
â”œâ”€â”€ backend/routes/myFeatureRoutes.ts
â”œâ”€â”€ database/myfeature_tables.sql
â”œâ”€â”€ module.config.ts
â””â”€â”€ README.md
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **å¼€ç®±å³ç”¨**
   - âœ… å®Œæ•´çš„è®¤è¯ç³»ç»Ÿ
   - âœ… 8ç§è¯­è¨€å›½é™…åŒ–
   - âœ… ç»Ÿä¸€åé¦ˆç³»ç»Ÿ
   - âœ… ä¸€é”®éƒ¨ç½²è„šæœ¬

2. **æ¨¡å—åŒ–è®¾è®¡**
   - âœ… æ ¸å¿ƒç³»ç»Ÿä¸ä¸šåŠ¡åˆ†ç¦»
   - âœ… å¯æ’æ‹”æ¨¡å—æ¶æ„
   - âœ… ç‹¬ç«‹çš„é…ç½®ç®¡ç†

3. **ç”Ÿäº§å°±ç»ª**
   - âœ… Dockerå®¹å™¨åŒ–
   - âœ… PostgreSQLæ€»ç³»ç»Ÿ
   - âœ… å¥åº·æ£€æŸ¥æœºåˆ¶
   - âœ… è‡ªåŠ¨SSLè¯ä¹¦

4. **å¯æ‰©å±•æ€§**
   - âœ… æ”¯æŒå¤šç«™ç‚¹éƒ¨ç½²
   - âœ… èµ„æºå…±äº«ä¼˜åŒ–
   - âœ… æ¨¡å—åŒ–æ‰©å±•

### æŠ€æœ¯äº®ç‚¹

- **TypeScriptå…¨æ ˆ**ï¼šç±»å‹å®‰å…¨ï¼Œå‡å°‘é”™è¯¯
- **React 18 + Hooks**ï¼šç°ä»£åŒ–å‰ç«¯æ¶æ„
- **JWTè®¤è¯**ï¼šæ— çŠ¶æ€è®¤è¯ï¼Œæ˜“äºæ‰©å±•
- **PostgreSQLæ€»ç³»ç»Ÿ**ï¼šå•å®ä¾‹å¤šç§Ÿæˆ·ï¼Œèµ„æºä¼˜åŒ–
- **Dockeréƒ¨ç½²**ï¼šç¯å¢ƒä¸€è‡´æ€§ï¼Œå¿«é€Ÿéƒ¨ç½²
- **åˆ†ç¦»å¼æ„å»º**ï¼šé¿å…å¤æ‚æ€§ï¼Œæé«˜å¯é æ€§

### é€‚ç”¨åœºæ™¯

1. **å¿«é€ŸåŸå‹å¼€å‘**ï¼š5åˆ†é’Ÿå¯åŠ¨æ–°é¡¹ç›®
2. **SaaSå¤šç§Ÿæˆ·åº”ç”¨**ï¼šå…±äº«èµ„æºï¼Œç‹¬ç«‹æ•°æ®
3. **å›½é™…åŒ–åº”ç”¨**ï¼š8ç§è¯­è¨€å¼€ç®±å³ç”¨
4. **æ¨¡å—åŒ–ä¸šåŠ¡**ï¼šå¯æ’æ‹”åŠŸèƒ½æ¨¡å—

---

## ğŸ¯ Site3 éƒ¨ç½²æˆåŠŸæ¡ˆä¾‹ (2024-10-02)

### éƒ¨ç½²ä¿¡æ¯

| é¡¹ç›® | é…ç½®å€¼ |
|------|--------|
| ç«™ç‚¹ID | site3 |
| è¡¨å‰ç¼€ | site3__ (åŒä¸‹åˆ’çº¿) |
| æ•°æ®åº“ç”¨æˆ· | site3_user |
| åŸŸå | game2030.top, www.game2030.top |
| éƒ¨ç½²è·¯å¾„ | /docker/site3 |
| å®¹å™¨åç§° | site3 |
| é•œåƒæ ‡ç­¾ | site3:latest |

### å…³é”®é…ç½®

#### backend/.env é…ç½®
```env
# PostgreSQLæ€»ç³»ç»Ÿé…ç½®
DB_HOST=postgres_master
DB_PORT=5432
DB_NAME=postgres
DB_USER=site3_user
DB_PASSWORD=site3_prod_pass_2024
DB_SSL=false
DB_MAX_CONNECTIONS=20

# ç«™ç‚¹é…ç½®
SITE_ID=site3
TABLE_PREFIX=site3__    # âš ï¸ æ³¨æ„ï¼šåŒä¸‹åˆ’çº¿

# åº”ç”¨é…ç½®
NODE_ENV=production
PORT=3000
USE_DATABASE=true

# JWTé…ç½®
JWT_SECRET=site3-jwt-secret-key-change-this-2024
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# CORSé…ç½®
ALLOWED_ORIGINS=https://game2030.top,https://www.game2030.top
FRONTEND_URL=https://game2030.top

# æ—¶åŒº
TZ=America/New_York

# åé¦ˆç³»ç»Ÿ
FEEDBACK_SITE_ID=site3

# ç¼“å­˜é…ç½®
CACHE_ENABLED=false
ENABLE_REDIS_CACHE=false
```

### éƒ¨ç½²æµç¨‹ï¼ˆå·²éªŒè¯æˆåŠŸï¼‰

#### æ­¥éª¤1: æœ¬åœ°å‡†å¤‡
```bash
# åœ¨æœ¬åœ°å¼€å‘æœºå™¨ä¸Š
cd "C:\Users\Administrator.USER-20240417KK\Documents\GitHub\template A"

# 1. ç¡®è®¤ä»£ç ä¿®æ”¹å®Œæˆ
# 2. æäº¤åˆ°Git
git add .
git commit -m "feat: integrate PostgreSQL master system"
git push origin main
```

#### æ­¥éª¤2: VPSæ‹‰å–ä»£ç 
```bash
# åœ¨VPSä¸Š
cd /docker/site3

# å¤‡ä»½.envæ–‡ä»¶
cp backend/.env backend/.env.backup

# æ‹‰å–æœ€æ–°ä»£ç 
git stash
git pull origin main
git stash pop

# æ¢å¤.envæ–‡ä»¶
cp backend/.env.backup backend/.env
```

#### æ­¥éª¤3: æ£€æŸ¥ç¼–è¯‘çŠ¶æ€
```bash
# æ£€æŸ¥distç›®å½•æ˜¯å¦å­˜åœ¨
if [ -d "backend/dist" ] && [ "$(ls -A backend/dist)" ]; then
    echo "âœ… distç›®å½•å·²å­˜åœ¨ï¼Œè·³è¿‡ç¼–è¯‘"
    # ä¿®æ”¹éƒ¨ç½²è„šæœ¬è·³è¿‡ç¼–è¯‘
    sed -i 's/npm run build/echo "ä½¿ç”¨å·²æœ‰distç›®å½•"/g' scripts/one-click-deploy-postgres.sh
else
    echo "âš ï¸ distç›®å½•ä¸å­˜åœ¨ï¼Œä½¿ç”¨Dockerç¼–è¯‘"
    cd backend
    docker run --rm -v $(pwd):/app -w /app node:22-alpine sh -c "npm install && npm run build"
    cd ..
fi
```

#### æ­¥éª¤4: æ‰§è¡Œä¸€é”®éƒ¨ç½²
```bash
chmod +x scripts/one-click-deploy-postgres.sh
./scripts/one-click-deploy-postgres.sh
```

### éƒ¨ç½²éªŒè¯ï¼ˆå…¨éƒ¨é€šè¿‡âœ…ï¼‰

```bash
# 1. ç¯å¢ƒé¢„æ£€æŸ¥ âœ…
âœ… Dockerå·²å®‰è£…: 28.4.0
âœ… ç¯å¢ƒæ–‡ä»¶å­˜åœ¨
âœ… ç«™ç‚¹ ID: site3
âœ… è¡¨å‰ç¼€: site3__
âœ… æ•°æ®åº“ä¸»æœº: postgres_master

# 2. PostgreSQLè¿æ¥æµ‹è¯• âœ…
âœ… postgres_masterå®¹å™¨æ­£åœ¨è¿è¡Œ
âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ
âœ… æ•°æ®åº“è¡¨å·²åˆå§‹åŒ–: site3__users

# 3. ç¼–è¯‘å’Œæ„å»º âœ…
âœ… TypeScriptç¼–è¯‘å®Œæˆ
âœ… å‰ç«¯æ„å»ºå®Œæˆ
âœ… Dockeré•œåƒæ„å»ºå®Œæˆ: site3:latest

# 4. ç½‘ç»œé…ç½® âœ…
âœ… ç½‘ç»œé…ç½®å®Œæˆ
âœ… å·²è¿æ¥webproxyç½‘ç»œ
âœ… å·²è¿æ¥shared_netç½‘ç»œ

# 5. æœåŠ¡å¯åŠ¨ âœ…
âœ… æ—§å®¹å™¨å·²æ¸…ç†
âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ: site3
âœ… å¯ä»¥è¿æ¥åˆ°PostgreSQLæ€»ç³»ç»Ÿ

# 6. éƒ¨ç½²æˆåŠŸ âœ…
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   âœ… éƒ¨ç½²æˆåŠŸï¼                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### å…³é”®é—®é¢˜è§£å†³è®°å½•

#### é—®é¢˜1: è¡¨å‰ç¼€ä¸ä¸€è‡´
**ç—‡çŠ¶**: 
```
ERROR: permission denied for table site3__users
```

**åŸå› **: 
- `.env`æ–‡ä»¶ä¸­é…ç½®çš„æ˜¯ `TABLE_PREFIX=site3_` (å•ä¸‹åˆ’çº¿)
- æ•°æ®åº“ä¸­å®é™…åˆ›å»ºçš„è¡¨æ˜¯ `site3__users` (åŒä¸‹åˆ’çº¿)
- å¯¼è‡´åº”ç”¨æŸ¥è¯¢ `site3_users` ä½†è¡¨åæ˜¯ `site3__users`

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤æ•°æ®åº“ä¸­çš„å®é™…è¡¨åï¼š
   ```bash
   docker exec postgres_master psql -U site3_user -d postgres -c "SELECT COUNT(*) FROM site3__users;"
   ```

2. ä¿®æ”¹ `.env` æ–‡ä»¶åŒ¹é…å®é™…è¡¨åï¼š
   ```env
   TABLE_PREFIX=site3__  # æ”¹ä¸ºåŒä¸‹åˆ’çº¿
   ```

3. éªŒè¯é…ç½®ï¼š
   ```bash
   grep "TABLE_PREFIX" backend/.env
   # è¾“å‡º: TABLE_PREFIX=site3__
   ```

**é¢„é˜²æªæ–½**:
- âœ… éƒ¨ç½²å‰å…ˆæ£€æŸ¥æ•°æ®åº“è¡¨å
- âœ… ç¡®ä¿ `.env` ä¸­çš„ `TABLE_PREFIX` ä¸å®é™…è¡¨åä¸€è‡´
- âœ… ä½¿ç”¨éªŒè¯è„šæœ¬è‡ªåŠ¨æ£€æŸ¥

#### é—®é¢˜2: .envæ–‡ä»¶æ ¼å¼é”™è¯¯
**ç—‡çŠ¶**:
```
âŒ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: DB_USER, DB_PASSWORD, TABLE_PREFIX
```

**åŸå› **:
- ä½¿ç”¨ `nano` ç¼–è¾‘æ—¶å¯èƒ½ä¿å­˜ä¸ºå•è¡Œ
- ç¯å¢ƒå˜é‡è¯»å–å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
ä½¿ç”¨ `cat` å‘½ä»¤é‡æ–°åˆ›å»º `.env` æ–‡ä»¶ï¼š
```bash
rm backend/.env
cat > backend/.env << 'EOF'
DB_HOST=postgres_master
DB_PORT=5432
# ... æ¯ä¸ªé…ç½®å•ç‹¬ä¸€è¡Œ
EOF
```

**é¢„é˜²æªæ–½**:
- âœ… ä½¿ç”¨è„šæœ¬ç”Ÿæˆ `.env` æ–‡ä»¶
- âœ… éƒ¨ç½²å‰éªŒè¯æ–‡ä»¶æ ¼å¼
- âœ… ä½¿ç”¨ `head -20 backend/.env` æ£€æŸ¥æ ¼å¼

#### é—®é¢˜3: npmç¼–è¯‘å¤±è´¥
**ç—‡çŠ¶**:
```
./scripts/one-click-deploy-postgres.sh: line 171: npm: command not found
```

**åŸå› **:
- VPSä¸Šæ²¡æœ‰å®‰è£… `npm`
- éƒ¨ç½²è„šæœ¬å°è¯•ç›´æ¥è¿è¡Œ `npm run build`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æ˜¯å¦å·²æœ‰ç¼–è¯‘äº§ç‰©ï¼š
   ```bash
   ls -la backend/dist/
   ```

2. å¦‚æœæœ‰ï¼Œä¿®æ”¹è„šæœ¬è·³è¿‡ç¼–è¯‘ï¼š
   ```bash
   sed -i 's/npm run build/echo "ä½¿ç”¨å·²æœ‰distç›®å½•"/g' scripts/one-click-deploy-postgres.sh
   ```

3. å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨Dockerå®¹å™¨ç¼–è¯‘ï¼š
   ```bash
   cd backend
   docker run --rm -v $(pwd):/app -w /app node:22-alpine sh -c "npm install && npm run build"
   cd ..
   ```

**é¢„é˜²æªæ–½**:
- âœ… æœ¬åœ°ç¼–è¯‘å¹¶æäº¤ `dist` ç›®å½•
- âœ… éƒ¨ç½²è„šæœ¬è‡ªåŠ¨æ£€æŸ¥ `dist` ç›®å½•
- âœ… ä½¿ç”¨Dockerå®¹å™¨ç¼–è¯‘ï¼ˆæ¨èï¼‰

### æœ€ä½³å®è·µæ€»ç»“

#### 1. éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•
```bash
# âœ… æ£€æŸ¥ç¯å¢ƒå˜é‡
cat backend/.env | grep -E "(SITE_ID|TABLE_PREFIX|DB_USER|DB_PASSWORD|DB_HOST|ALLOWED_ORIGINS)"

# âœ… æ£€æŸ¥æ•°æ®åº“è¡¨
docker exec postgres_master psql -U admin -d postgres -c "\dt site3__*"

# âœ… æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·
docker exec postgres_master psql -U admin -d postgres -c "\du" | grep site3

# âœ… æ£€æŸ¥æƒé™
docker exec postgres_master psql -U admin -d postgres -c "
SELECT grantee, table_name, privilege_type 
FROM information_schema.table_privileges 
WHERE grantee = 'site3_user' AND table_name LIKE 'site3__%' 
LIMIT 10;
"

# âœ… éªŒè¯distç›®å½•
ls -la backend/dist/ | head -10
```

#### 2. éƒ¨ç½²æµç¨‹æ ‡å‡†åŒ–
```bash
# æ ‡å‡†éƒ¨ç½²æµç¨‹ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰
cd /docker/site3

# 1. å¤‡ä»½é…ç½®
cp backend/.env backend/.env.backup

# 2. æ‹‰å–ä»£ç 
git stash
git pull origin main
git stash pop

# 3. æ¢å¤é…ç½®
cp backend/.env.backup backend/.env

# 4. éªŒè¯é…ç½®
echo "=== éªŒè¯ .env å…³é”®é…ç½® ==="
cat backend/.env | grep -E "(SITE_ID|TABLE_PREFIX|DB_USER|DB_PASSWORD)"

# 5. æ£€æŸ¥ç¼–è¯‘äº§ç‰©
if [ -d "backend/dist" ] && [ "$(ls -A backend/dist)" ]; then
    echo "âœ… ä½¿ç”¨å·²æœ‰distç›®å½•"
    sed -i 's/npm run build/echo "ä½¿ç”¨å·²æœ‰distç›®å½•"/g' scripts/one-click-deploy-postgres.sh
fi

# 6. æ‰§è¡Œéƒ¨ç½²
./scripts/one-click-deploy-postgres.sh
```

#### 3. é…ç½®æ–‡ä»¶è§„èŒƒ

**backend/.env æ¨¡æ¿**:
```env
# PostgreSQLæ€»ç³»ç»Ÿé…ç½®
DB_HOST=postgres_master          # å›ºå®šå€¼
DB_PORT=5432                     # å›ºå®šå€¼
DB_NAME=postgres                 # å›ºå®šå€¼
DB_USER=site3_user               # æ ¹æ®ç«™ç‚¹ä¿®æ”¹
DB_PASSWORD=your_password_here   # å¿…é¡»ä¿®æ”¹
DB_SSL=false                     # VPSå†…éƒ¨é€šä¿¡
DB_MAX_CONNECTIONS=20            # æ¨èå€¼

# ç«™ç‚¹é…ç½®ï¼ˆâš ï¸ å…³é”®é…ç½®ï¼‰
SITE_ID=site3                    # ç«™ç‚¹æ ‡è¯†
TABLE_PREFIX=site3__             # âš ï¸ å¿…é¡»ä¸æ•°æ®åº“å®é™…è¡¨åä¸€è‡´ï¼

# åº”ç”¨é…ç½®
NODE_ENV=production
PORT=3000
USE_DATABASE=true

# JWTé…ç½®ï¼ˆâš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰
JWT_SECRET=your-super-secret-jwt-key-change-this
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# CORSé…ç½®ï¼ˆâš ï¸ å¿…é¡»é…ç½®å®é™…åŸŸåï¼‰
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
FRONTEND_URL=https://yourdomain.com

# æ—¶åŒº
TZ=America/New_York

# åé¦ˆç³»ç»Ÿ
FEEDBACK_SITE_ID=site3

# ç¼“å­˜é…ç½®
CACHE_ENABLED=false
ENABLE_REDIS_CACHE=false
```

### é¢„é˜²å¼å¤„ç†å»ºè®®

#### 1. ä»£ç çº§é¢„é˜²
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®è¡¨å‰ç¼€
- âœ… å¯åŠ¨æ—¶éªŒè¯æ•°æ®åº“è¿æ¥
- âœ… å¯åŠ¨æ—¶éªŒè¯è¡¨æ˜¯å¦å­˜åœ¨
- âœ… æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹

#### 2. éƒ¨ç½²è„šæœ¬å¢å¼º
```bash
# åœ¨éƒ¨ç½²è„šæœ¬ä¸­æ·»åŠ ï¼š
# 1. è¡¨å‰ç¼€éªŒè¯
# 2. æ•°æ®åº“è¿æ¥æµ‹è¯•
# 3. è¡¨å­˜åœ¨æ€§æ£€æŸ¥
# 4. æƒé™éªŒè¯
```

#### 3. æ–‡æ¡£å®Œå–„
- âœ… è®°å½•å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- âœ… æä¾›æ ‡å‡†é…ç½®æ¨¡æ¿
- âœ… æ›´æ–°éƒ¨ç½²æ£€æŸ¥æ¸…å•

### åç»­å·¥ä½œ

#### NPMé…ç½®ï¼ˆä¸‹ä¸€æ­¥ï¼‰
1. ç™»å½• NPM: `http://YOUR_VPS_IP:81`
2. æ·»åŠ ä»£ç†ä¸»æœº:
   - Domain: game2030.top, www.game2030.top
   - Forward Hostname: site3
   - Forward Port: 3000
3. ç”³è¯·SSLè¯ä¹¦
4. æµ‹è¯•è®¿é—®: https://game2030.top

#### ç›‘æ§å’Œç»´æŠ¤
```bash
# æŸ¥çœ‹æ—¥å¿—
docker logs site3 -f

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep site3

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec site3 nc -zv postgres_master 5432

# æŸ¥çœ‹åé¦ˆæ•°æ®
docker exec postgres_master psql -U site3_user -d postgres -c \
  "SELECT * FROM unified_feedback WHERE site_id='site3' LIMIT 5;"
```

---

## ğŸ” Site3 æ–°è®¤è¯ç³»ç»Ÿé‡æ„æ¡ˆä¾‹ (2025-10-02)

### èƒŒæ™¯

**é—®é¢˜ç—‡çŠ¶**ï¼š
```
æ³¨å†Œå¤±è´¥: Error: relation "users" does not exist
ValidationError: The 'X-Forwarded-For' header is set but the Express 'trust proxy' setting is false
```

**æ ¹æœ¬åŸå› **ï¼š
1. âŒ æ—§è®¤è¯ç³»ç»Ÿç¡¬ç¼–ç è¡¨å `users`ï¼Œæœªä½¿ç”¨ `TABLE_PREFIX` ç¯å¢ƒå˜é‡
2. âŒ Expressåº”ç”¨æœªå¯ç”¨ `trust proxy`ï¼Œå¯¼è‡´åœ¨Nginxä»£ç†åæ— æ³•æ­£ç¡®è¯†åˆ«å®¢æˆ·ç«¯IP
3. âŒ PostgreSQLæ•°æ®åº“ä¸­å®é™…è¡¨åæ˜¯ `site3__users`ï¼Œä½†ä»£ç æŸ¥è¯¢ `users` è¡¨

---

### è§£å†³æ–¹æ¡ˆï¼šå®Œå…¨é‡å†™è®¤è¯ç³»ç»Ÿ

#### æ–°è®¤è¯ç³»ç»Ÿæ¶æ„

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**ï¼š
- âœ… 100% åŸºäºç¯å¢ƒå˜é‡é©±åŠ¨ï¼ˆTABLE_PREFIXï¼‰
- âœ… ä»£ç ä¸­ç»ä¸ç¡¬ç¼–ç è¡¨å
- âœ… æ”¯æŒ PostgreSQL æ€»ç³»ç»Ÿçš„å¤šç«™ç‚¹æ¶æ„
- âœ… å¯ç”¨ Express trust proxyï¼ˆé€‚é…Nginxåå‘ä»£ç†ï¼‰

**æ–°å¢æ–‡ä»¶**ï¼š
```typescript
backend/src/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ tables.ts                  # ğŸ†• è¡¨åé…ç½®ï¼ˆä½¿ç”¨TABLE_PREFIXï¼‰
â”œâ”€â”€ services/auth/
â”‚   â””â”€â”€ authService.ts             # â™»ï¸ é‡å†™ï¼ˆä½¿ç”¨AUTH_TABLESï¼‰
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ authController.ts          # â™»ï¸ é‡å†™ï¼ˆæ–°éªŒè¯é€»è¾‘ï¼‰
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ auth.ts                    # â™»ï¸ é‡å†™ï¼ˆåŠ¨æ€è·¯ç”±æ³¨å†Œï¼‰
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ auth.ts                    # â™»ï¸ é‡å†™ï¼ˆJWTéªŒè¯ï¼‰
â””â”€â”€ initAuthSystem.ts              # ğŸ†• è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–
```

#### å…³é”®ä»£ç å®ç°

**1. è¡¨åé…ç½®ï¼ˆbackend/src/config/tables.tsï¼‰**ï¼š
```typescript
// è·å–è¡¨å‰ç¼€ï¼ˆä»ç¯å¢ƒå˜é‡ï¼‰
const TABLE_PREFIX = process.env.TABLE_PREFIX || '';

// éªŒè¯è¡¨å‰ç¼€
if (!TABLE_PREFIX) {
  console.warn('âš ï¸ TABLE_PREFIX æœªè®¾ç½®ï¼Œå°†ä½¿ç”¨æ— å‰ç¼€çš„è¡¨åï¼ˆä¸æ¨èï¼‰');
}

console.log(`ğŸ“Š æ•°æ®åº“è¡¨å‰ç¼€: "${TABLE_PREFIX}"`);

// è®¤è¯ç›¸å…³è¡¨å
export const AUTH_TABLES = {
  USERS: `${TABLE_PREFIX}users`,
  REFRESH_TOKENS: `${TABLE_PREFIX}refresh_tokens`,
} as const;
```

**2. è®¤è¯æœåŠ¡ï¼ˆbackend/src/services/auth/authService.tsï¼‰**ï¼š
```typescript
import { AUTH_TABLES } from '../../config/tables';

export class AuthService {
  async register(data: RegisterData) {
    // âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®çš„è¡¨å
    const query = `
      INSERT INTO ${AUTH_TABLES.USERS} 
        (username, email, password_hash, ...)
      VALUES ($1, $2, $3, ...)
      RETURNING id, username, email, ...
    `;
    
    console.log(`ğŸ’¾ æ’å…¥ç”¨æˆ·åˆ°è¡¨: ${AUTH_TABLES.USERS}`);
    const result = await this.pool.query(query, values);
    // å®é™…æ‰§è¡Œ: INSERT INTO site3__users ...
  }
}
```

**3. Expressä¸»å…¥å£ï¼ˆbackend/src/index.tsï¼‰**ï¼š
```typescript
import { initAuthSystem } from './initAuthSystem';
import { databaseService } from './services/database/databaseServiceFactory';
import { PostgreSQLService } from './services/database/postgresService';

const app = express();

// âš™ï¸ å¯ç”¨ trust proxy - å› ä¸ºåº”ç”¨åœ¨ Nginx ä»£ç†åé¢
app.set('trust proxy', 1);

// åœ¨æ•°æ®åº“åˆå§‹åŒ–åï¼ŒåŠ¨æ€æ³¨å†Œè®¤è¯è·¯ç”±
async function initializeServices() {
  await initializeDatabaseService();
  const dbInfo = getDatabaseServiceInfo();
  
  if (dbInfo.type === 'postgresql' && databaseService instanceof PostgreSQLService) {
    console.log('ğŸ” åˆå§‹åŒ–è®¤è¯ç³»ç»Ÿ...');
    const { authRouter } = initAuthSystem(databaseService.pool);
    app.use('/api/auth', authRouter);
    console.log('âœ… æ–°è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    console.log(`ğŸ“Š æ•°æ®åº“è¡¨å‰ç¼€: "${process.env.TABLE_PREFIX || '(æ— )'}"`);
  }
}
```

---

### éƒ¨ç½²æµç¨‹

#### ç¬¬1æ­¥ï¼šæœ¬åœ°ç¼–è¯‘

```bash
cd backend
npm run build
# ç¡®ä¿ç¼–è¯‘æˆåŠŸï¼Œæ— TypeScripté”™è¯¯
```

#### ç¬¬2æ­¥ï¼šGitæäº¤

```bash
git add backend/src backend/dist
git commit -m "feat: é‡å†™è®¤è¯ç³»ç»Ÿ - å®Œå…¨åŸºäºTABLE_PREFIXç¯å¢ƒå˜é‡"
git push origin main
```

#### ç¬¬3æ­¥ï¼šVPSéƒ¨ç½²

```bash
# 1. SSHè¿æ¥åˆ°VPS
ssh root@YOUR_VPS_IP

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /docker/site3

# 3. å¤‡ä»½.envæ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
cp backend/.env backend/.env.backup.$(date +%Y%m%d_%H%M%S)
cp backend/.env backend/.env.backup

# 4. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
docker stop site3
docker rm site3
docker rmi site3:latest

# 5. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 6. éªŒè¯.envé…ç½®
cat backend/.env | grep -E "(TABLE_PREFIX|DB_USER|ALLOWED_ORIGINS)"

# 7. ä¸€é”®éƒ¨ç½²
./scripts/one-click-deploy-postgres.sh
```

#### ç¬¬4æ­¥ï¼šéªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker logs site3 --tail 100

# åº”è¯¥çœ‹åˆ°ï¼š
# ğŸ“Š æ•°æ®åº“è¡¨å‰ç¼€: "site3__"
# ğŸ“‹ å½“å‰æ•°æ®åº“è¡¨é…ç½®:
#   - ç”¨æˆ·è¡¨: site3__users
#   - åˆ·æ–°ä»¤ç‰Œè¡¨: site3__refresh_tokens
# ğŸ” è®¤è¯æœåŠ¡åˆå§‹åŒ–å®Œæˆ
#   - ä½¿ç”¨è¡¨: site3__users
#   - Token æœ‰æ•ˆæœŸ: 15m
# âœ… æ–°è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
```

---

### éƒ¨ç½²è¿‡ç¨‹ä¸­çš„æŒ‘æˆ˜

#### æŒ‘æˆ˜1ï¼šVPSç£ç›˜ç©ºé—´100%æ»¡

**ç—‡çŠ¶**ï¼š
```
could not extend file "base/5/16583": No space left on device
```

**åŸå› åˆ†æ**ï¼š
- ç£ç›˜ä½¿ç”¨ï¼š30G / 30G (100%)
- `/var/lib/docker`: 25Gï¼ˆå¤§é‡æœªä½¿ç”¨çš„é•œåƒï¼‰
- `/var/log`: 1.3Gï¼ˆç³»ç»Ÿæ—¥å¿—ï¼‰
- 15+ä¸ªæ‚¬ç©ºé•œåƒï¼ˆ`<none>`æ ‡ç­¾ï¼‰= 15-20GB

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ¸…ç†æ‚¬ç©ºé•œåƒ
docker image prune -a -f
# é‡Šæ”¾ï¼š15.29GB

# 2. æ¸…ç†ç³»ç»Ÿæ—¥å¿—
journalctl --vacuum-size=100M
find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
# é‡Šæ”¾ï¼š1.3GB

# 3. åˆ é™¤ç©ºç™½ç«™ç‚¹ï¼ˆsite10-20ï¼‰
for i in {10..20}; do
  docker stop site$i 2>/dev/null
  docker rm site$i 2>/dev/null
  rm -rf /docker/site$i
done
# é‡Šæ”¾ï¼š0.1GB

# 4. æ¸…ç†Dockerç¼“å­˜
docker builder prune -a -f
apt clean

# æ€»è®¡é‡Šæ”¾ï¼šçº¦18GB
# ç»“æœï¼š30G â†’ 12Gä½¿ç”¨ï¼Œ18Gå¯ç”¨
```

**é¢„é˜²æªæ–½**ï¼š
- âœ… å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„Dockeré•œåƒ
- âœ… é™åˆ¶Dockerå®¹å™¨æ—¥å¿—å¤§å°
- âœ… é…ç½®æ—¥å¿—è½®è½¬ç­–ç•¥
- âœ… ç›‘æ§ç£ç›˜ä½¿ç”¨ç‡

---

### éƒ¨ç½²éªŒè¯ç»“æœ

#### âœ… ç³»ç»Ÿå¯åŠ¨æ—¥å¿—

```
ğŸ—„ï¸ ä½¿ç”¨PostgreSQLæ•°æ®åº“æœåŠ¡
ğŸ“Š æ•°æ®åº“é…ç½®: {
  host: 'postgres_master',
  port: '5432',
  database: 'postgres',
  user: 'site3_user',
  ssl: false
}
ğŸ“Š æ•°æ®åº“è¡¨å‰ç¼€: "site3__"
ğŸ“‹ å½“å‰æ•°æ®åº“è¡¨é…ç½®:
  - ç”¨æˆ·è¡¨: site3__users
  - åˆ·æ–°ä»¤ç‰Œè¡¨: site3__refresh_tokens
ğŸ”§ å¼€å§‹åˆå§‹åŒ–æœåŠ¡...
ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“æœåŠ¡...
âœ… PostgreSQLè¿æ¥æµ‹è¯•æˆåŠŸ
âœ… æ•°æ®åº“æœåŠ¡å·²åˆå§‹åŒ–: POSTGRESQL
ğŸ” åˆå§‹åŒ–è®¤è¯ç³»ç»Ÿ...
ğŸ” è®¤è¯æœåŠ¡åˆå§‹åŒ–å®Œæˆ
  - ä½¿ç”¨è¡¨: site3__users
  - Token æœ‰æ•ˆæœŸ: 15m
ğŸ® è®¤è¯æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ
ğŸ›£ï¸ åˆå§‹åŒ–è®¤è¯è·¯ç”±
âœ… è®¤è¯è·¯ç”±æ³¨å†Œå®Œæˆ:
  - POST /api/auth/register (å…¬å¼€)
  - POST /api/auth/login (å…¬å¼€)
  - GET  /api/auth/me (å—ä¿æŠ¤)
  - POST /api/auth/logout (å—ä¿æŠ¤)
âœ… æ–°è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
ğŸ“Š æ•°æ®åº“è¡¨å‰ç¼€: "site3__"
ğŸš€ Server running on port 3000
```

#### âœ… å…³é”®éªŒè¯ç‚¹

1. **è¡¨å‰ç¼€é…ç½®æ­£ç¡®**ï¼š
   ```
   âœ… ğŸ“Š æ•°æ®åº“è¡¨å‰ç¼€: "site3__"
   âœ… ä½¿ç”¨è¡¨: site3__users
   ```

2. **æ— trust proxyè­¦å‘Š**ï¼š
   ```
   âœ… æ²¡æœ‰ "X-Forwarded-For" ç›¸å…³è­¦å‘Š
   ```

3. **æ— è¡¨ä¸å­˜åœ¨é”™è¯¯**ï¼š
   ```
   âœ… æ²¡æœ‰ "relation 'users' does not exist" é”™è¯¯
   ```

4. **CORSé…ç½®æ­£ç¡®**ï¼š
   ```
   âœ… å…è®¸çš„CORSæº: [
     'https://game2030.top',
     'https://www.game2030.top',
     /^https:\/\/.*\.vercel\.app$/
   ]
   ```

5. **æ³¨å†ŒåŠŸèƒ½æµ‹è¯•æˆåŠŸ**ï¼š
   ```
   âœ… ç”¨æˆ·æˆåŠŸæ³¨å†Œ
   âœ… è¿”å›æ­£ç¡®çš„JWT token
   âœ… æ•°æ®æ­£ç¡®å†™å…¥ site3__users è¡¨
   ```

---

### æŠ€æœ¯äº®ç‚¹

#### 1. ç¯å¢ƒå˜é‡é©±åŠ¨æ¶æ„

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸€å¥—ä»£ç æ”¯æŒå¤šç«™ç‚¹
- âœ… ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒè¡¨å‰ç¼€
- âœ… é¿å…ç¡¬ç¼–ç ï¼Œæé«˜çµæ´»æ€§

**å®ç°**ï¼š
```typescript
// config/tables.ts
const TABLE_PREFIX = process.env.TABLE_PREFIX || '';

export const AUTH_TABLES = {
  USERS: `${TABLE_PREFIX}users`,
  // è¿è¡Œæ—¶æ ¹æ®ç¯å¢ƒå˜é‡åŠ¨æ€ç¡®å®šè¡¨å
  // site3: site3__users
  // site4: site4__users
  // ...
};
```

#### 2. åŠ¨æ€è·¯ç”±æ³¨å†Œ

**ä¼˜åŠ¿**ï¼š
- âœ… ç¡®ä¿æ•°æ®åº“è¿æ¥å¯ç”¨åå†æ³¨å†Œè·¯ç”±
- âœ… é¿å…å¯åŠ¨æ—¶çš„ç«æ€æ¡ä»¶
- âœ… æ¸…æ™°çš„åˆå§‹åŒ–æµç¨‹

**å®ç°**ï¼š
```typescript
// index.ts
async function initializeServices() {
  await initializeDatabaseService();
  
  if (dbInfo.type === 'postgresql') {
    const { authRouter } = initAuthSystem(pool);
    app.use('/api/auth', authRouter);
  }
}
```

#### 3. Trust Proxyé…ç½®

**ä¼˜åŠ¿**ï¼š
- âœ… æ­£ç¡®è¯†åˆ«Nginxä»£ç†åçš„å®¢æˆ·ç«¯IP
- âœ… æ”¯æŒé€Ÿç‡é™åˆ¶æŒ‰çœŸå®IPè®¡ç®—
- âœ… ç¬¦åˆç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

**å®ç°**ï¼š
```typescript
// index.ts
app.set('trust proxy', 1);
// 1 = ä¿¡ä»»ç¬¬ä¸€å±‚ä»£ç†ï¼ˆNginx Proxy Managerï¼‰
```

---

### ç»éªŒæ€»ç»“

#### æˆåŠŸå› ç´ 

1. **å½»åº•é‡å†™ vs ä¿®è¡¥**ï¼š
   - âœ… é€‰æ‹©é‡å†™è€Œéä¿®è¡¥æ—§ä»£ç 
   - âœ… ä»è®¾è®¡å±‚é¢è§£å†³é—®é¢˜
   - âœ… ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§æ›´å¥½

2. **ç¯å¢ƒå˜é‡ä¼˜å…ˆ**ï¼š
   - âœ… æ‰€æœ‰é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡
   - âœ… ä»£ç ä¸­é›¶ç¡¬ç¼–ç 
   - âœ… æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²

3. **å®Œæ•´çš„æ—¥å¿—è¾“å‡º**ï¼š
   - âœ… æ¯ä¸ªå…³é”®æ­¥éª¤éƒ½æœ‰æ—¥å¿—
   - âœ… ä¾¿äºé—®é¢˜è¯Šæ–­
   - âœ… éªŒè¯é…ç½®æ­£ç¡®æ€§

4. **å¤‡ä»½ä¼˜å…ˆåŸåˆ™**ï¼š
   - âœ… éƒ¨ç½²å‰å¤‡ä»½.envæ–‡ä»¶
   - âœ… ä½¿ç”¨æ—¶é—´æˆ³å¤‡ä»½
   - âœ… åŒé‡å¤‡ä»½ä¿é™©

#### æœ€ä½³å®è·µ

**1. è¡¨åé…ç½®ç®¡ç†**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šé›†ä¸­ç®¡ç†ï¼Œä½¿ç”¨å¸¸é‡
import { AUTH_TABLES } from './config/tables';
const query = `SELECT * FROM ${AUTH_TABLES.USERS}`;

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç è¡¨å
const query = `SELECT * FROM users`;
```

**2. éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•**ï¼š
```bash
# âœ… æ£€æŸ¥è¡¨å‰ç¼€ä¸€è‡´æ€§
docker exec postgres_master psql -U admin -d postgres -c "\dt site3__*"
grep "TABLE_PREFIX" backend/.env

# âœ… æ£€æŸ¥ç¼–è¯‘äº§ç‰©
ls -la backend/dist/

# âœ… éªŒè¯.envæ ¼å¼
head -20 backend/.env

# âœ… æµ‹è¯•æ•°æ®åº“è¿æ¥
docker exec site3 nc -zv postgres_master 5432
```

**3. ç£ç›˜ç©ºé—´ç®¡ç†**ï¼š
```bash
# âœ… å®šæœŸæ¸…ç†ï¼ˆæ¯å‘¨ï¼‰
docker image prune -a -f
docker builder prune -a -f
journalctl --vacuum-size=100M

# âœ… ç›‘æ§ç£ç›˜ä½¿ç”¨
df -h | grep vda1
du -sh /var/lib/docker
```

---

### æœªæ¥æ”¹è¿›æ–¹å‘

1. **è‡ªåŠ¨åŒ–éƒ¨ç½²æ£€æŸ¥**ï¼š
   - æ·»åŠ pre-deploymentéªŒè¯è„šæœ¬
   - è‡ªåŠ¨æ£€æŸ¥è¡¨å‰ç¼€ä¸€è‡´æ€§
   - éªŒè¯ç¯å¢ƒå˜é‡å®Œæ•´æ€§

2. **ç›‘æ§å’Œå‘Šè­¦**ï¼š
   - ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡ç›‘æ§
   - æ•°æ®åº“è¿æ¥æ± ç›‘æ§
   - APIé”™è¯¯ç‡ç›‘æ§

3. **æ–‡æ¡£å®Œå–„**ï¼š
   - æ ‡å‡†åŒ–éƒ¨ç½²SOP
   - å¸¸è§é—®é¢˜çŸ¥è¯†åº“
   - æ•…éšœæ’æŸ¥æ‰‹å†Œ

---

## ğŸ“Š éƒ¨ç½²è®°å½•æ±‡æ€»

| æ—¥æœŸ | ç«™ç‚¹ | ç±»å‹ | çŠ¶æ€ | å…³é”®é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|------|------|------|---------|---------|
| 2024-10-02 | Site3 | åˆå§‹éƒ¨ç½² | âœ… æˆåŠŸ | TABLE_PREFIXä¸ä¸€è‡´ | ä¿®æ­£.envé…ç½® |
| 2025-10-02 | Site3 | è®¤è¯ç³»ç»Ÿé‡æ„ | âœ… æˆåŠŸ | ç¡¬ç¼–ç è¡¨å + trust proxy | å®Œå…¨é‡å†™ + å¯ç”¨trust proxy |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**æ›´æ–°æ—¶é—´**: 2025-10-02  
**ç»´æŠ¤è€…**: Template Team  
**æœ€åéƒ¨ç½²**: Site3 æ–°è®¤è¯ç³»ç»Ÿ - 2025-10-02 (æˆåŠŸâœ…)

