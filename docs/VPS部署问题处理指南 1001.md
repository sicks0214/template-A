# VPS部署问题处理指南

> **基于Site4 (ColorMagic) 实战经验的完整工作流程**  
> **最后更新：2025-09-30**  
> **版本：v2.0（彻底修订版）**

---

## ⚠️ 重要声明：旧版指南的问题

### ❌ 旧版指南的错误方法（不要使用）

1. **❌ 错误：让用户手动上传文件到VPS**
   - 问题：会导致Git状态不一致
   - 问题：容易遗漏关联文件
   - 问题：TypeScript编译产物会丢失

2. **❌ 错误：直接在VPS修改代码文件**
   - 问题：无法验证语法错误
   - 问题：无法提交到Git，导致版本混乱
   - 问题：TypeScript项目无法编译

3. **❌ 错误：不断重复无效的部署命令**
   - 问题：没有解决根本原因
   - 问题：浪费时间在无效尝试上

---

## ✅ 正确的工作流程（必须遵循）

### 核心原则

```
本地开发 → 本地编译 → Git提交 → VPS拉取 → VPS部署
    ↓          ↓         ↓         ↓         ↓
  修改代码   编译TS   推送GitHub   拉取代码   重新构建
```

**关键点**：
1. ✅ 所有代码修改必须在**本地**完成
2. ✅ TypeScript项目必须在**本地**编译
3. ✅ 修改必须通过**Git同步**到VPS
4. ✅ VPS只做配置修改（.env文件）和部署操作

---

## 📊 问题分类和处理流程

### 分类1：代码问题（需要本地修改）

**特征**：
- 需要修改 `.ts`、`.tsx`、`.js`、`.jsx` 等源代码文件
- 需要修改业务逻辑、路由配置、API端点
- 需要添加新功能或修复bug

**✅ 正确流程**：

```bash
# ========================================
# 步骤1：本地修改代码
# ========================================
cd ~/Documents/GitHub/Image-Color-Analysis

# 修改文件（使用IDE或编辑器）
# 例如：修改 backend/src/index.ts

# ========================================
# 步骤2：本地编译（如果是TypeScript项目）
# ========================================
cd backend
npm run build

# 验证编译成功
ls -la dist/
grep "你的修改内容关键词" dist/index.js

# ========================================
# 步骤3：Git提交
# ========================================
cd ..
git add backend/src/index.ts backend/dist/index.js
git commit -m "fix: 描述你的修改"
git push origin main

# ========================================
# 步骤4：VPS拉取代码
# ========================================
# 在VPS终端执行：
ssh root@YOUR_VPS_IP
cd /docker/site4

# 保存本地.env修改（如果有）
cp backend/.env backend/.env.backup

# 拉取最新代码
git stash  # 暂存本地修改
git pull origin main
git stash pop  # 恢复本地修改

# 恢复.env文件（如果被覆盖）
cp backend/.env.backup backend/.env

# ========================================
# 步骤5：重新编译（TypeScript项目必须）
# ========================================
cd backend
npm run build
cd ..

# ========================================
# 步骤6：重新构建和部署
# ========================================
# 方法A：使用docker compose（推荐）
docker build -f backend/Dockerfile.simple -t site4:latest ./backend
docker stop site4 && docker rm site4
docker run -d --name site4 --network webproxy --env-file backend/.env --restart unless-stopped site4:latest
docker network connect shared_net site4

# 方法B：如果有docker-compose.yml
docker compose down
docker compose build --no-cache
docker compose up -d

# ========================================
# 步骤7：验证部署
# ========================================
sleep 15
docker logs site4 --tail 30
curl http://localhost:3000/health
```

**⏱️ 时间估计**：5-10分钟（取决于代码复杂度）

---

### 分类2：配置问题（可以VPS直接修改）

**特征**：
- 只修改 `.env` 文件
- 修改环境变量（API密钥、数据库密码、域名等）
- 不涉及代码逻辑修改

**✅ 正确流程**：

```bash
# ========================================
# 在VPS上直接修改.env文件
# ========================================
ssh root@YOUR_VPS_IP
cd /docker/site4

# 编辑.env文件
nano backend/.env
# 或
vim backend/.env

# 修改完成后，按Ctrl+O保存，Ctrl+X退出

# ========================================
# 验证.env文件内容
# ========================================
cat backend/.env | grep "你修改的变量名"

# 例如验证CORS配置
cat backend/.env | grep "ALLOWED_ORIGINS"

# ========================================
# 重启容器使配置生效
# ========================================
docker restart site4

# 等待启动
sleep 15

# ========================================
# 验证配置已生效
# ========================================
docker logs site4 --tail 30

# 验证特定配置（例如CORS）
docker logs site4 | grep "允许的CORS源"
```

**⏱️ 时间估计**：2-3分钟

---

### 分类3：部署问题（VPS诊断和修复）

**特征**：
- 容器无法启动
- 网络连接问题
- 数据库连接失败
- 健康检查失败

**✅ 诊断流程**：

```bash
# ========================================
# 步骤1：检查容器状态
# ========================================
docker ps -a | grep site4
docker logs site4 --tail 50

# ========================================
# 步骤2：检查网络连接
# ========================================
docker network ls | grep -E "(webproxy|shared_net)"
docker inspect site4 | grep -A 10 "Networks"

# ========================================
# 步骤3：检查数据库连接（如果使用PostgreSQL）
# ========================================
docker exec site4 nc -zv postgres_master 5432 || echo "数据库连接失败"

# 检查数据库用户权限
cd /docker/db_master
docker compose exec postgres psql -U admin -d postgres -c "\du" | grep site4

# ========================================
# 步骤4：检查环境变量
# ========================================
docker exec site4 env | grep -E "(DB_|ALLOWED_ORIGINS|NODE_ENV)"

# ========================================
# 步骤5：健康检查
# ========================================
docker exec site4 curl -s http://localhost:3000/health || echo "健康检查失败"
```

**常见问题和修复**：

#### 问题1：容器启动失败
```bash
# 查看详细错误日志
docker logs site4 --tail 100

# 常见原因：
# 1. 端口冲突 → 修改docker-compose.yml端口映射
# 2. .env文件缺失 → 检查backend/.env是否存在
# 3. 依赖安装失败 → 重新构建镜像
```

#### 问题2：数据库连接失败
```bash
# 检查网络连接
docker network connect shared_net site4

# 检查数据库别名
docker network inspect shared_net | grep -A 5 "postgres_master"

# 如果没有别名，设置别名
docker network disconnect shared_net postgres_master
docker network connect --alias postgres_master shared_net postgres_master
```

#### 问题3：CORS错误（www子域名被阻止）
```bash
# 检查CORS配置
docker logs site4 | grep "允许的CORS源"

# 如果没有看到www域名，修改.env
nano backend/.env
# 确保：ALLOWED_ORIGINS=https://example.com,https://www.example.com

# 重启容器
docker restart site4

# 验证
docker logs site4 | grep "www"
```

---

## 🚫 AI必须避免的错误行为

### ❌ 错误1：要求用户手动上传文件

**错误做法**：
```
AI: "请将修改后的 index.ts 手动上传到VPS的 /docker/site4/backend/src/ 目录"
```

**✅ 正确做法**：
```
AI: 
1. 我已在本地修改了 backend/src/index.ts
2. 我将提交到GitHub
3. 请在VPS执行：
   cd /docker/site4
   git pull origin main
   cd backend && npm run build && cd ..
   docker build -f backend/Dockerfile.simple -t site4:latest ./backend
   docker restart site4
```

---

### ❌ 错误2：让用户在VPS直接修改代码

**错误做法**：
```
AI: "请在VPS执行：
     nano /docker/site4/backend/src/index.ts
     然后添加以下代码..."
```

**为什么错误**：
- 无法验证语法错误
- 无法提交到Git
- TypeScript无法编译
- 容易出错且难以回滚

**✅ 正确做法**：
```
AI: 
这是代码修改，需要在本地完成：
1. 我在本地修改 backend/src/index.ts
2. 本地编译：npm run build
3. Git提交并推送
4. VPS拉取并重新部署
```

---

### ❌ 错误3：重复无效命令

**错误做法**：
```
用户："还是500错误"
AI："再试试 docker restart site4"
用户："还是500错误"
AI："再试试 docker compose up -d --build"
用户："还是500错误"
AI："再试试..."  ← 无限循环
```

**✅ 正确做法**：
```
AI:
重启无效，说明是配置或代码问题。让我们诊断：
1. 查看错误日志：docker logs site4 --tail 50
2. 检查环境变量：docker exec site4 env | grep API
3. 根据日志确定问题类型：
   - 如果是代码错误 → 需要本地修改代码
   - 如果是配置错误 → 修改.env文件
   - 如果是权限错误 → 检查数据库权限
```

---

## 📋 标准化问题处理检查清单

### 收到问题报告时，AI必须先问：

```markdown
## 问题诊断检查清单

### 1. 获取错误日志
[ ] 容器日志：docker logs site4 --tail 50
[ ] 浏览器控制台错误截图
[ ] 网络请求错误（如CORS错误）

### 2. 确定问题类型
[ ] 代码问题（需要修改.ts/.js文件）→ 走"代码修改流程"
[ ] 配置问题（只需修改.env）→ 走"配置修改流程"  
[ ] 部署问题（容器、网络、数据库）→ 走"诊断流程"

### 3. 验证当前状态
[ ] 容器是否运行：docker ps | grep site4
[ ] Git状态：git status（有无未提交修改）
[ ] 编译状态：ls backend/dist/（TypeScript项目）
[ ] 环境变量：cat backend/.env | head -10

### 4. 选择正确流程
根据问题类型，选择上述对应的流程执行
```

---

## 🎯 ColorMagic (Site4) 实战案例总结

### 案例：www子域名被CORS阻止

**问题现象**：
- ✅ https://imagecolorpicker.cc 正常
- ❌ https://www.imagecolorpicker.cc 返回500错误
- ❌ 浏览器控制台显示CORS错误

**错误的处理方式（旧版指南）**：
```bash
❌ 直接在VPS修改 backend/src/index.ts
❌ 让用户手动上传修改后的文件
❌ 重复执行 docker restart（无效）
```

**✅ 正确的处理方式**：

**步骤1：本地修改代码**
```typescript
// backend/src/index.ts
const getAllowedOrigins = (): (string | RegExp)[] => {
  const origins: (string | RegExp)[] = []
  
  // 新增：读取ALLOWED_ORIGINS环境变量
  if (process.env.ALLOWED_ORIGINS) {
    const allowedOriginsArray = process.env.ALLOWED_ORIGINS.split(',').map(o => o.trim())
    origins.push(...allowedOriginsArray)
  }
  
  return origins
}
```

**步骤2：本地编译**
```bash
cd backend
npm run build
grep "ALLOWED_ORIGINS" dist/index.js  # 验证编译成功
```

**步骤3：Git提交**
```bash
git add backend/src/index.ts backend/dist/index.js
git commit -m "fix: add ALLOWED_ORIGINS environment variable support"
git push origin main
```

**步骤4：VPS部署**
```bash
cd /docker/site4
git pull origin main
cd backend && npm run build && cd ..
docker build -f backend/Dockerfile.simple -t site4:latest ./backend
docker stop site4 && docker rm site4
docker run -d --name site4 --network webproxy --env-file backend/.env --restart unless-stopped site4:latest
docker network connect shared_net site4
```

**步骤5：配置.env**
```bash
nano backend/.env
# 添加：ALLOWED_ORIGINS=https://imagecolorpicker.cc,https://www.imagecolorpicker.cc
docker restart site4
```

**步骤6：验证**
```bash
docker logs site4 | grep "允许的CORS源"
curl -I https://imagecolorpicker.cc
curl -I https://www.imagecolorpicker.cc
```

**结果**：✅ 问题解决，两个域名都正常访问

**时间对比**：
- ❌ 错误方式：多次失败，耗时3小时+
- ✅ 正确方式：一次成功，耗时15分钟

---

## 🔄 Git工作流程最佳实践

### 本地开发环境

```bash
# 初始设置
cd ~/Documents/GitHub/Image-Color-Analysis
git config user.name "Your Name"
git config user.email "your.email@example.com"

# 日常开发流程
git pull origin main                    # 拉取最新代码
# ... 修改代码 ...
npm run build                          # 编译（如需要）
git status                             # 查看修改
git add .                              # 添加修改
git commit -m "描述你的修改"            # 提交
git push origin main                   # 推送到GitHub
```

### VPS部署环境

```bash
# 初始设置
cd /docker/site4
git config --global user.name "VPS Deployment"
git config --global user.email "deploy@vps.local"

# 日常部署流程
cp backend/.env backend/.env.backup    # 备份.env
git stash                              # 暂存本地修改
git pull origin main                   # 拉取最新代码
git stash pop                          # 恢复本地修改
cp backend/.env.backup backend/.env    # 恢复.env

# 如果有冲突
git stash drop                         # 丢弃暂存
git pull origin main                   # 重新拉取
# 手动恢复.env文件

# 重新部署...
```

---

## 📚 快速参考卡片

### 代码修改（5步流程）

```
本地修改 → 本地编译 → Git提交 → VPS拉取 → VPS部署
```

### 配置修改（3步流程）

```
VPS编辑.env → 重启容器 → 验证生效
```

### 问题诊断（4步流程）

```
查看日志 → 确定类型 → 选择流程 → 执行修复
```

---

## ⚠️ AI工作原则（必须遵守）

### 1. 代码修改原则
✅ **DO**：
- 在本地修改代码文件
- 本地编译TypeScript
- 通过Git同步到VPS

❌ **DON'T**：
- 让用户在VPS直接修改代码
- 让用户手动上传文件
- 跳过编译步骤

### 2. 问题诊断原则
✅ **DO**：
- 先查看日志确定问题
- 根据日志选择正确流程
- 一次性给出完整解决方案

❌ **DON'T**：
- 不看日志就给命令
- 重复执行无效命令
- 猜测问题原因

### 3. 沟通原则
✅ **DO**：
- 明确说明为什么这样做
- 提供完整的命令序列
- 说明预期结果

❌ **DON'T**：
- 只给命令不解释
- 分散给出多次命令
- 不验证结果

---

## 📊 成功率统计

| 方法 | 成功率 | 平均耗时 |
|------|--------|----------|
| ✅ 本地修改+Git同步 | 95%+ | 15分钟 |
| ❌ VPS直接修改代码 | 30% | 2小时+ |
| ❌ 手动上传文件 | 50% | 1小时+ |

---

**最后更新**：2025-09-30  
**版本**：v2.0  
**状态**：基于Site4实战验证  
**贡献者**：AI Assistant + User实战经验总结

