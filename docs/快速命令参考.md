# Template A - 快速命令参考

> 常用命令速查表  
> **GitHub**: https://github.com/sicks0214/template-A

---

## 🔧 本地开发

### TypeScript编译
```bash
cd backend
npm run build
grep "database" dist/config/database.js  # 验证编译
```

### 前端开发
```bash
cd frontend
npm run dev          # 开发服务器
npm run build        # 生产构建
```

### Git操作
```bash
git status
git add .
git commit -m "feat: 描述"
git push origin main

# 查看提交历史
git log --oneline -10
```

---

## 🚀 VPS部署

### 首次部署
```bash
# SSH连接
ssh root@YOUR_VPS_IP

# 克隆项目
cd /docker
git clone https://github.com/sicks0214/template-A.git site5
cd site5

# 配置环境
cp backend/.env.production backend/.env
nano backend/.env

# 初始化数据库
nano database/vps/template-a-init.sql  # 修改配置
docker exec -i postgres_master psql -U admin -d postgres < database/vps/template-a-init.sql

# 一键部署
chmod +x scripts/one-click-deploy-postgres.sh
./scripts/one-click-deploy-postgres.sh
```

### 代码更新
```bash
cd /docker/site5
cp backend/.env backend/.env.backup
git stash && git pull origin main && git stash pop
cp backend/.env.backup backend/.env
./scripts/one-click-deploy-postgres.sh
```

### 配置更新
```bash
cd /docker/site5
nano backend/.env
docker restart site5
docker logs site5 --tail 30
```

---

## 🐳 Docker命令

### 容器管理
```bash
# 查看运行容器
docker ps
docker ps | grep site5

# 查看所有容器
docker ps -a

# 启动/停止/重启
docker start site5
docker stop site5
docker restart site5

# 删除容器
docker stop site5 && docker rm site5

# 查看日志
docker logs site5
docker logs site5 --tail 50
docker logs site5 -f           # 实时日志
docker logs site5 --since 10m  # 最近10分钟
```

### 镜像管理
```bash
# 查看镜像
docker images | grep site5

# 构建镜像
docker build -f backend/Dockerfile.simple -t site5:latest ./backend

# 无缓存构建
docker build --no-cache -f backend/Dockerfile.simple -t site5:latest ./backend

# 删除镜像
docker rmi site5:latest

# 清理未使用镜像
docker image prune -a
```

### 网络管理
```bash
# 查看网络
docker network ls
docker network ls | grep -E "(webproxy|shared_net)"

# 查看网络详情
docker network inspect shared_net
docker network inspect shared_net | grep site5

# 连接网络
docker network connect shared_net site5
docker network connect webproxy site5

# 断开网络
docker network disconnect shared_net site5
```

### 容器操作
```bash
# 进入容器
docker exec -it site5 sh
docker exec -it site5 /bin/bash

# 在容器中执行命令
docker exec site5 ls -la
docker exec site5 pwd
docker exec site5 env | grep DB

# 查看容器信息
docker inspect site5
docker inspect site5 | grep IPAddress
docker inspect site5 | grep -A 10 "Networks"

# 容器资源使用
docker stats site5
docker stats --no-stream site5
```

---

## 🗄️ PostgreSQL命令

### 连接数据库
```bash
# 使用admin用户
docker exec -it postgres_master psql -U admin -d postgres

# 使用站点用户
docker exec -it postgres_master psql -U site5_user -d postgres
```

### 常用psql命令
```sql
-- 列出所有数据库
\l

-- 列出所有表
\dt

-- 列出站点表
\dt myapp_*

-- 查看表结构
\d myapp_users

-- 列出所有用户
\du

-- 退出
\q
```

### 数据查询
```bash
# 单行命令
docker exec postgres_master psql -U site5_user -d postgres -c "SELECT COUNT(*) FROM myapp_users;"

# 查看反馈数据
docker exec postgres_master psql -U site5_user -d postgres -c "
SELECT id, site_id, content, created_at 
FROM unified_feedback 
WHERE site_id='site5' 
ORDER BY created_at DESC 
LIMIT 5;
"

# 查看用户列表
docker exec postgres_master psql -U site5_user -d postgres -c "
SELECT id, username, email, created_at 
FROM myapp_users 
ORDER BY created_at DESC 
LIMIT 10;
"
```

### 数据库维护
```bash
# 备份数据库
docker exec postgres_master pg_dump -U admin postgres > backup_$(date +%Y%m%d).sql

# 恢复数据库
docker exec -i postgres_master psql -U admin postgres < backup.sql

# 查看数据库大小
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables 
WHERE tablename LIKE 'myapp_%'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
"
```

---

## 🔍 诊断命令

### 健康检查
```bash
# 获取容器IP
CONTAINER_IP=$(docker inspect site5 | grep -m1 '"IPAddress"' | cut -d'"' -f4)
echo $CONTAINER_IP

# 测试健康端点
curl http://$CONTAINER_IP:3000/health
curl -I http://$CONTAINER_IP:3000/health

# 从容器内部测试
docker exec site5 curl -s http://localhost:3000/health

# 测试API
curl http://$CONTAINER_IP:3000/api/health
```

### 网络测试
```bash
# 测试DNS解析
docker exec site5 ping -c 2 postgres_master
docker exec site5 nslookup postgres_master

# 测试端口连接
docker exec site5 nc -zv postgres_master 5432
docker exec site5 telnet postgres_master 5432

# 查看网络配置
docker exec site5 ip addr
docker exec site5 cat /etc/hosts
```

### 日志分析
```bash
# 查找错误
docker logs site5 2>&1 | grep -i error
docker logs site5 2>&1 | grep -i warning

# 查找特定内容
docker logs site5 | grep "数据库"
docker logs site5 | grep "CORS"
docker logs site5 | grep "PostgreSQL"

# 导出日志
docker logs site5 > site5_logs_$(date +%Y%m%d_%H%M%S).log
```

### 环境变量检查
```bash
# 查看所有环境变量
docker exec site5 env

# 查看特定环境变量
docker exec site5 env | grep DB
docker exec site5 env | grep SITE_ID
docker exec site5 env | grep TABLE_PREFIX
docker exec site5 env | grep ALLOWED_ORIGINS

# 在VPS上查看.env文件
cat /docker/site5/backend/.env
cat /docker/site5/backend/.env | grep -E "(DB_|SITE_ID|TABLE_PREFIX)"
```

---

## 🌐 Nginx Proxy Manager

### 访问NPM
```bash
# 浏览器访问
http://YOUR_VPS_IP:81

# 默认账号
# Email: admin@example.com
# Password: changeme
```

### 查看NPM日志
```bash
docker logs nginx-proxy-manager
docker logs nginx-proxy-manager --tail 100
```

---

## 📊 监控命令

### 系统资源
```bash
# 查看所有容器资源使用
docker stats

# 查看单个容器资源
docker stats site5 --no-stream

# 查看磁盘使用
docker system df

# 查看Docker空间使用
docker system df -v
```

### 容器状态
```bash
# 查看容器运行时间
docker ps --format "table {{.Names}}\t{{.Status}}"

# 查看容器重启次数
docker inspect site5 --format '{{.RestartCount}}'

# 查看容器启动时间
docker inspect site5 --format '{{.State.StartedAt}}'
```

---

## 🧹 清理命令

### 安全清理（仅清理site5相关）
```bash
# 停止并删除容器
docker stop site5
docker rm site5

# 删除镜像
docker rmi site5:latest

# 清理构建缓存
docker builder prune
```

### 全局清理（危险！影响所有项目）
```bash
# ⚠️ 仅在确定时使用

# 清理未使用的容器
docker container prune

# 清理未使用的镜像
docker image prune -a

# 清理未使用的卷
docker volume prune

# 清理未使用的网络
docker network prune

# 清理所有未使用资源
docker system prune -a --volumes
```

---

## 🔐 安全命令

### 文件权限
```bash
# 设置.env文件权限
chmod 600 /docker/site5/backend/.env

# 查看文件权限
ls -la /docker/site5/backend/.env
```

### 密码生成
```bash
# 生成随机密码
openssl rand -base64 32

# 生成JWT密钥
openssl rand -base64 64
```

---

## 📝 快速部署脚本

### 创建快速部署别名
```bash
# 在VPS的 ~/.bashrc 或 ~/.zshrc 中添加
alias site5-deploy='cd /docker/site5 && ./scripts/one-click-deploy-postgres.sh'
alias site5-logs='docker logs site5 -f'
alias site5-restart='docker restart site5'
alias site5-status='docker ps | grep site5 && docker stats site5 --no-stream'

# 重新加载配置
source ~/.bashrc
```

### 使用别名
```bash
site5-deploy   # 一键部署
site5-logs     # 查看日志
site5-restart  # 重启容器
site5-status   # 查看状态
```

---

## 🎯 完整部署流程（一行命令）

### 本地提交
```bash
cd backend && npm run build && cd .. && git add . && git commit -m "update" && git push
```

### VPS部署
```bash
cd /docker/site5 && cp backend/.env backend/.env.backup && git stash && git pull && git stash pop && cp backend/.env.backup backend/.env && ./scripts/one-click-deploy-postgres.sh
```

---

**最后更新**: 2024-10-02  
**版本**: 1.0

