# 新认证系统部署指南

> **完全重写，删除旧系统，使用 TABLE_PREFIX 环境变量**  
> **最后更新**: 2025-10-02

---

## 🎯 变更概述

### ✅ 已完成的修改

1. **删除旧文件**（无备份）：
   - `backend/src/services/auth/authService.ts` (旧)
   - `backend/src/controllers/authController.ts` (旧)
   - `backend/src/routes/auth.ts` (旧)
   - `backend/src/middleware/auth.ts` (旧)

2. **创建新文件**：
   - `backend/src/config/tables.ts` - 表名配置（使用 TABLE_PREFIX）
   - `backend/src/services/auth/authService.ts` - 新认证服务
   - `backend/src/controllers/authController.ts` - 新认证控制器
   - `backend/src/routes/auth.ts` - 新认证路由
   - `backend/src/middleware/auth.ts` - 新JWT中间件
   - `backend/src/initAuthSystem.ts` - 认证系统初始化

3. **修改主入口文件** (`backend/src/index.ts`)：
   - ✅ 添加 `app.set('trust proxy', 1)` - 解决 X-Forwarded-For 警告
   - ✅ 导入并初始化新认证系统
   - ✅ 在数据库服务初始化后注册认证路由

---

## 📋 核心改进

### 1️⃣ 完全基于 TABLE_PREFIX 环境变量

**旧系统问题**：
```typescript
// ❌ 硬编码表名
const query = 'SELECT * FROM users WHERE email = $1';
```

**新系统方案**：
```typescript
// ✅ 使用环境变量
import { AUTH_TABLES } from '../../config/tables';
const query = `SELECT * FROM ${AUTH_TABLES.USERS} WHERE email = $1`;
// 实际执行: SELECT * FROM site3__users WHERE email = $1
```

### 2️⃣ 解决 Trust Proxy 警告

```typescript
// backend/src/index.ts (第 45 行)
app.set('trust proxy', 1);
```

这解决了以下警告：
```
ValidationError: The 'X-Forwarded-For' header is set but the Express 'trust proxy' setting is false
```

### 3️⃣ 动态路由注册

认证路由在数据库初始化后动态注册，确保数据库连接池可用：

```typescript
// backend/src/index.ts (第 246-251 行)
if (dbInfo.pool) {
  const { authRouter } = initAuthSystem(dbInfo.pool);
  app.use('/api/auth', authRouter);
  console.log('✅ 新认证系统初始化完成');
}
```

---

## 🚀 部署步骤

### 第 1 步：本地编译

```bash
cd backend
npm run build
```

**预期输出**：
```
✔ Compiled successfully
✔ Generated backend/dist/
```

### 第 2 步：Git 提交

```bash
git add backend/
git commit -m "feat: 重写认证系统 - 完全基于TABLE_PREFIX环境变量"
git push origin main
```

### 第 3 步：VPS 部署

```bash
# SSH 连接到 VPS
ssh root@YOUR_VPS_IP

# 进入项目目录
cd /docker/site3

# 备份 .env 文件
cp backend/.env backend/.env.backup

# 拉取最新代码
git pull origin main

# 恢复 .env 文件
cp backend/.env.backup backend/.env

# 一键部署
./scripts/one-click-deploy-postgres.sh
```

### 第 4 步：验证部署

```bash
# 等待容器启动
sleep 10

# 查看日志
docker logs site3 --tail 50

# 应该看到以下日志：
# 📊 数据库表前缀: "site3__"
# 🔐 初始化认证系统...
# 🔐 认证服务初始化完成
#   - 使用表: site3__users
#   - Token 有效期: 15m
# 🎮 认证控制器初始化完成
# 🛣️ 初始化认证路由
# ✅ 认证路由注册完成:
#   - POST /api/auth/register (公开)
#   - POST /api/auth/login (公开)
#   - GET  /api/auth/me (受保护)
#   - POST /api/auth/logout (受保护)
# ✅ 新认证系统初始化完成
# 📊 数据库表前缀: "site3__"
```

### 第 5 步：测试注册

```bash
# 测试注册接口
curl -X POST https://www.game2030.top/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "password123"
  }'

# 应该返回：
# {
#   "success": true,
#   "message": "注册成功",
#   "data": {
#     "user": { ... },
#     "token": "eyJhbGc...",
#     "refreshToken": "eyJhbGc..."
#   }
# }
```

---

## 🔍 关键文件说明

### 1. `backend/src/config/tables.ts`

**作用**：集中管理所有表名，使用 `TABLE_PREFIX` 环境变量

**代码**：
```typescript
const TABLE_PREFIX = process.env.TABLE_PREFIX || '';

export const AUTH_TABLES = {
  USERS: `${TABLE_PREFIX}users`,
  REFRESH_TOKENS: `${TABLE_PREFIX}refresh_tokens`,
} as const;
```

### 2. `backend/src/initAuthSystem.ts`

**作用**：初始化认证系统的所有组件

**代码**：
```typescript
export function initAuthSystem(pool: Pool) {
  const authService = new AuthService(pool);
  const authController = new AuthController(authService);
  const authRouter = createAuthRouter(authController);
  
  return { authService, authController, authRouter };
}
```

### 3. `backend/src/index.ts` (修改部分)

**修改1** - 添加 Trust Proxy (第 45 行)：
```typescript
app.set('trust proxy', 1);
```

**修改2** - 导入新认证系统 (第 12 行)：
```typescript
import { initAuthSystem } from './initAuthSystem';
```

**修改3** - 初始化新认证系统 (第 246-251 行)：
```typescript
if (dbInfo.pool) {
  console.log('🔐 初始化认证系统...');
  const { authRouter } = initAuthSystem(dbInfo.pool);
  app.use('/api/auth', authRouter);
  console.log('✅ 新认证系统初始化完成');
}
```

---

## ✅ 验证检查清单

部署完成后，请确认以下项目：

```bash
# ✅ 1. 容器运行正常
docker ps | grep site3
# 应该显示 STATUS 为 Up

# ✅ 2. 日志无错误
docker logs site3 --tail 50 | grep -i "error\|fail"
# 应该没有错误（忽略之前的历史错误）

# ✅ 3. 看到表前缀日志
docker logs site3 --tail 50 | grep "表前缀"
# 应该显示: 📊 数据库表前缀: "site3__"

# ✅ 4. 看到认证系统初始化日志
docker logs site3 --tail 50 | grep "认证"
# 应该显示多行初始化日志

# ✅ 5. Trust Proxy 警告消失
docker logs site3 --tail 50 | grep "trust proxy"
# 应该没有警告

# ✅ 6. 健康检查正常
curl https://www.game2030.top/api/health
# 应该返回: {"status":"ok","timestamp":"..."}

# ✅ 7. 测试注册接口
curl -X POST https://www.game2030.top/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","email":"test@test.com","password":"123456"}'
# 应该返回成功响应（如果用户不存在）
```

---

## 🐛 问题排查

### 问题 1: 仍然报 "relation 'users' does not exist"

**原因**：某个地方还在使用硬编码的表名

**排查**：
```bash
# 在代码中搜索硬编码的表名
cd backend/src
grep -r "FROM users" .
grep -r "'users'" .
grep -r "\"users\"" .

# 应该只在 tables.ts 中出现
```

### 问题 2: 日志中没有 "表前缀" 信息

**原因**：`TABLE_PREFIX` 环境变量未设置

**解决**：
```bash
# 检查 .env 文件
cat /docker/site3/backend/.env | grep TABLE_PREFIX

# 应该是：
# TABLE_PREFIX=site3__

# 如果没有，添加它
echo "TABLE_PREFIX=site3__" >> /docker/site3/backend/.env

# 重启容器
docker restart site3
```

### 问题 3: "认证系统初始化" 日志未出现

**原因**：数据库连接池未初始化

**解决**：
```bash
# 检查数据库连接
docker logs site3 --tail 100 | grep -i "database\|postgres"

# 应该看到：
# ✅ 数据库服务已初始化: POSTGRESQL
# ✅ PostgreSQL连接测试成功

# 如果没有，检查数据库配置
cat /docker/site3/backend/.env | grep DB_
```

---

## 📊 环境变量配置参考

以下是 Site3 的完整环境变量配置：

```bash
# 数据库配置
USE_DATABASE=true
DB_HOST=postgres_master
DB_PORT=5432
DB_NAME=postgres
DB_USER=site3_user
DB_PASSWORD=your_password_here
DB_SSL=false
DB_MAX_CONNECTIONS=20

# 表前缀（⚠️ 必须设置！）
TABLE_PREFIX=site3__

# 站点标识
SITE_ID=site3

# JWT 配置
JWT_SECRET=your_super_secret_jwt_key_change_this
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# 其他配置
NODE_ENV=production
PORT=3000
ALLOWED_ORIGINS=https://game2030.top,https://www.game2030.top
```

---

## 🎉 部署成功标志

当你看到以下日志时，说明部署成功：

```bash
docker logs site3 --tail 50

# 应该包含：
🔧 开始初始化服务...
🗄️ 初始化数据库服务...
✅ 数据库服务已初始化: POSTGRESQL
📊 数据库表前缀: "site3__"
📋 当前数据库表配置:
  - 用户表: site3__users
  - 刷新令牌表: site3__refresh_tokens
🔐 初始化认证系统...
🔐 认证服务初始化完成
  - 使用表: site3__users
  - Token 有效期: 15m
🎮 认证控制器初始化完成
🛣️ 初始化认证路由
✅ 认证路由注册完成:
  - POST /api/auth/register (公开)
  - POST /api/auth/login (公开)
  - GET  /api/auth/me (受保护)
  - POST /api/auth/logout (受保护)
✅ 新认证系统初始化完成
📊 数据库表前缀: "site3__"
✅ 服务初始化完成
🚀 Server running on port 3000
```

---

## 📞 需要帮助？

- 查看完整文档：`docs/应用接入PostgreSQL总系统指南.md`
- 查看部署问题处理：`docs/VPS部署问题处理指南 1001.md`
- 查看程序架构：`docs/程序架构总结.md`

---

**版本**: v2.0  
**最后更新**: 2025-10-02  
**适用站点**: Site3 及所有使用 PostgreSQL 总系统的站点

